<!DOCTYPE html>
<html>
<head>
    <title>建造系統測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #333;
            color: white;
        }
        #log {
            height: 400px;
            overflow-y: scroll;
            background: #222;
            padding: 10px;
            border: 1px solid #666;
            margin-top: 20px;
        }
        button {
            padding: 10px;
            margin: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>建造工人系統測試</h1>
    <p>打開瀏覽器控制台來查看詳細的調試信息</p>
    
    <div>
        <button onclick="startGame()">開始遊戲</button>
        <button onclick="buildCastle()">建造城堡</button>
        <button onclick="checkWorkers()">檢查工人狀態</button>
        <button onclick="clearLog()">清除日誌</button>
    </div>
    
    <div id="log"></div>

    <script>
        let world;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function startGame() {
            log('開始初始化遊戲...');
            
            // 模擬簡化的遊戲環境
            const mockGrid = {
                gridToWorld: (x, z) => ({ x: x * 2, z: z * 2 }),
                worldToGrid: (x, z) => ({ x: Math.floor(x / 2), y: Math.floor(z / 2) }),
                occupyArea: () => {},
                canBuild: () => true,
                checkBuildingSpacing: () => true,
                checkBuildingCondition: () => true
            };
            
            const mockScene = {
                add: () => {},
                remove: () => {}
            };
            
            log('創建建築管理器...');
            window.buildingManager = {
                castles: [],
                towers: [],
                houses: [],
                farms: [],
                buildings: new Map()
            };
            
            log('創建村民管理器...');
            window.villagers = [];
            
            log('遊戲初始化完成！');
        }
        
        function buildCastle() {
            if (!window.buildingManager) {
                log('請先開始遊戲！');
                return;
            }
            
            log('建造城堡...');
            
            // 創建模擬建築
            const castle = {
                x: 10,
                y: 10,
                width: 6,
                height: 6,
                isUnderConstruction: true,
                isComplete: false,
                constructionWorkers: [],
                requiredWorkers: 2,
                maxWorkers: 4,
                constructor: { name: 'Castle' },
                
                needsMoreWorkers: function() {
                    const needs = this.isUnderConstruction && this.constructionWorkers.length < this.requiredWorkers;
                    log(`城堡需要更多工人檢查: 建造中=${this.isUnderConstruction}, 工人=${this.constructionWorkers.length}/${this.requiredWorkers}, 需要=${needs}`);
                    return needs;
                },
                
                getWorkerPositions: function() {
                    return [
                        { x: 12, y: 8 },
                        { x: 8, y: 8 },
                        { x: 12, y: 12 },
                        { x: 8, y: 12 }
                    ];
                },
                
                addWorker: function(villager) {
                    if (this.constructionWorkers.length < this.maxWorkers) {
                        this.constructionWorkers.push(villager);
                        log(`工人 ${villager.id} 加入城堡建造隊伍`);
                        return true;
                    }
                    return false;
                },
                
                getWorldPosition: function() {
                    return { x: this.x * 2, z: this.y * 2 };
                }
            };
            
            window.buildingManager.castles.push(castle);
            log('城堡建造成功，需要2個工人！');
            
            // 創建一些村民來測試
            for (let i = 0; i < 3; i++) {
                const villager = {
                    id: `villager_${i}`,
                    x: 5 + i * 2,
                    z: 5,
                    state: 'idle',
                    wood: 0,
                    food: 0,
                    constructionBuilding: null,
                    workPosition: null,
                    
                    tryFindConstructionWork: function() {
                        log(`村民 ${this.id} 開始尋找建造工作...`);
                        
                        const allBuildings = [...window.buildingManager.castles];
                        log(`檢查 ${allBuildings.length} 個建築`);
                        
                        for (const building of allBuildings) {
                            if (building.needsMoreWorkers()) {
                                log(`找到需要工人的建築: ${building.constructor.name}`);
                                
                                const workerPositions = building.getWorkerPositions();
                                const availablePosition = workerPositions[building.constructionWorkers.length];
                                
                                if (availablePosition && building.addWorker(this)) {
                                    this.constructionBuilding = building;
                                    this.workPosition = availablePosition;
                                    this.state = 'constructing';
                                    
                                    log(`村民 ${this.id} 開始協助建造 ${building.constructor.name}`);
                                    return true;
                                }
                            }
                        }
                        
                        log(`村民 ${this.id} 沒有找到建造工作`);
                        return false;
                    }
                };
                
                window.villagers.push(villager);
                log(`創建村民 ${villager.id}`);
            }
        }
        
        function checkWorkers() {
            if (!window.villagers || !window.buildingManager) {
                log('請先開始遊戲並建造建築！');
                return;
            }
            
            log('=== 檢查工人狀態 ===');
            
            // 讓每個閒置村民嘗試尋找工作
            window.villagers.forEach(villager => {
                if (villager.state === 'idle') {
                    log(`村民 ${villager.id} 處於閒置狀態，嘗試尋找工作...`);
                    villager.tryFindConstructionWork();
                } else {
                    log(`村民 ${villager.id} 當前狀態: ${villager.state}`);
                }
            });
            
            // 檢查建築狀態
            window.buildingManager.castles.forEach(castle => {
                log(`城堡工人狀態: ${castle.constructionWorkers.length}/${castle.requiredWorkers}`);
                castle.constructionWorkers.forEach(worker => {
                    log(`  - 工人 ${worker.id} 正在建造`);
                });
            });
        }
        
        // 頁面載入時初始化
        window.onload = function() {
            log('頁面載入完成，準備測試建造系統');
        };
    </script>
</body>
</html>
