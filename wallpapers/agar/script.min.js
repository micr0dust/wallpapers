const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),leaderboardElement=document.getElementById("leaderboard"),gameContainer=document.getElementById("game-container"),gameElementToFade=gameContainer||canvas;let players=[],foods=[],viruses=[],feedPellets=[],nameList=NAME_LIST,currentNameIndex=0,nextPlayerId=0;const MIN_ACTIVE_PLAYERS=20,initialPlayerCount=MIN_ACTIVE_PLAYERS,maxFoodCount=300,foodRadius=3,initialVirusCount=5,virusRadius=35,virusColor="#33ff33",virusSpikeCount=10,virusSplitMassThresholdMultiplier=1.15,playerSplitPieces=7,playerSplitMinMassPerPiece=300,playerSplitBurstSpeed=1,respawnDelay=5e3,MAX_DELTA_TIME=50,LEADERBOARD_UPDATE_INTERVAL=300,MERGE_COOLDOWN=12e3,FLEE_EDGE_DISTANCE_THRESHOLD=25,PLAYER_EAT_DISTANCE_FACTOR=.4,VIRUS_SPLIT_DISTANCE_FACTOR=.4,MERGE_OVERLAP_FACTOR=.8,INTRA_PLAYER_REPULSION_ENABLED=!0,REPULSION_FORCE_MULTIPLIER=.2,REPULSION_EFFECTIVE_DISTANCE_FACTOR=1.4,REPULSION_MIN_FORCE_FACTOR=.05,REPULSION_FADE_WINDOW_MS=3e3,AI_CAN_FEED_VIRUS=!0,MIN_MASS_TO_FEED_VIRUS=1e4,VIRUS_FEED_MASS_COST=1e3,VIRUS_MAX_FEED_COUNT=7,FEED_VIRUS_RANGE_FACTOR=.8,FEED_TARGET_MAX_MASS_FACTOR=100,FEED_EDGE_PROXIMITY_THRESHOLD=50,AI_FEED_VIRUS_PROBABILITY=.3,AI_FEED_VIRUS_COOLDOWN_DURATION=2e4,PELLET_SPEED=10,PELLET_LIFESPAN=800,PELLET_RADIUS=15,MAX_SPAWN_ATTEMPTS=100,SPAWN_SAFETY_BUFFER=15;let cellBaseSpeedMultiplier=6;const CELL_SPEED_MASS_FACTOR=1.1,RESET_ON_MAP_COVERAGE=!0,MAP_COVERAGE_RADIUS_FACTOR=.9,INTRA_PLAYER_COLLISION_ENABLED=!0,FADE_DURATION=7e3,BLACK_SCREEN_DURATION=500;let debug_draw_ai_view=!1,leaderboardUpdateCooldown=LEADERBOARD_UPDATE_INTERVAL,lastTime=0,isPausedForFade=!1,isResettingGame=!1,isGameRunning=!1,audioContext=null,backgroundMusicBuffer=null,backgroundMusicSource=null;function getRandomColor(){let t,s,e,i="#";do{i="#";const a="0123456789ABCDEF";for(let t=0;t<6;t++)i+=a[Math.floor(16*Math.random())];t=parseInt(i.substring(1,3),16),s=parseInt(i.substring(3,5),16),e=parseInt(i.substring(5,7),16)}while(t+s+e<380);return i}function getRandomInt(t,s){return Math.floor(Math.random()*(s-t+1))+t}function distanceSq(t,s,e,i){const a=e-t,n=i-s;return a*a+n*n}function shuffleArray(t){if(t&&0!==t.length)for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}}function getNextName(){if(!nameList||0===nameList.length)return`Cell_${Math.floor(1e3*Math.random())}`;const t=nameList[currentNameIndex];return currentNameIndex=(currentNameIndex+1)%nameList.length,t}async function base64ToArrayBuffer(t){try{const s=t.split(",")[1]||t,e=window.atob(s),i=e.length,a=new Uint8Array(i);for(let t=0;t<i;t++)a[t]=e.charCodeAt(t);return a.buffer}catch(t){throw t}}async function loadAudio(t){if(!audioContext)return null;if(!t)return null;try{const s=await base64ToArrayBuffer(t);return await audioContext.decodeAudioData(s)}catch(t){return null}}function startBackgroundMusic(){if(audioContext)if("suspended"!==audioContext.state){if(backgroundMusicBuffer){if(backgroundMusicSource){try{backgroundMusicSource.stop()}catch(t){}try{backgroundMusicSource.disconnect()}catch(t){}backgroundMusicSource=null}try{backgroundMusicSource=audioContext.createBufferSource(),backgroundMusicSource.buffer=backgroundMusicBuffer,backgroundMusicSource.loop=!0,backgroundMusicSource.connect(audioContext.destination),backgroundMusicSource.start(0)}catch(t){backgroundMusicSource=null}}}else audioContext.resume().catch((t=>{}))}function stopBackgroundMusic(){if(backgroundMusicSource){try{backgroundMusicSource.stop(),backgroundMusicSource.disconnect()}catch(t){}backgroundMusicSource=null}}function initAudioContext(){if(!audioContext)try{if(audioContext=new(window.AudioContext||window.webkitAudioContext),"suspended"===audioContext.state){let t=!1;const s=()=>{t&&(audioContext&&"suspended"===audioContext.state&&audioContext.resume().then((()=>{isGameRunning&&backgroundMusicBuffer&&!backgroundMusicSource&&startBackgroundMusic()})).catch((t=>{})),document.body.removeEventListener("click",s),document.body.removeEventListener("keydown",s),t=!1)};t||(document.body.addEventListener("click",s,{once:!0}),document.body.addEventListener("keydown",s,{once:!0}),t=!0)}}catch(t){audioContext=null}}window.wallpaperPropertyListener={applyUserProperties:function(t){t.cellbasespeed&&(cellBaseSpeedMultiplier=t.cellbasespeed.value),t.debugdrawaiview&&(debug_draw_ai_view=t.debugdrawaiview.value)}};class FeedPellet{constructor(t,s,e,i,a,n){this.x=t,this.y=s,this.radius=a,this.color=n;const r=e-t,o=i-s,l=Math.sqrt(r*r+o*o),h=l>.1?l/10*16.67:100;this.lifeTimer=h,l>.1?(this.vx=r/l*10,this.vy=o/l*10):(this.vx=10*(Math.random()-.5)*.1,this.vy=10*(Math.random()-.5)*.1,this.lifeTimer=100)}update(t){if(this.lifeTimer-=t,this.lifeTimer<=0)return!1;const s=t/16.67;return this.x+=this.vx*s,this.y+=this.vy*s,!0}draw(){ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fill(),ctx.closePath()}}class LogicalPlayer{constructor(t,s){this.id=nextPlayerId++,this.name=t||getNextName(),this.color=s||getRandomColor(),this.cells=[],this.totalMass=0,this.isEaten=!1,this.respawnTimer=0,this.isSplitting=!1,this.aiTarget=null,this.aiUpdateCooldown=200*Math.random(),this.aiUpdateInterval=200+150*Math.random(),this.aiFeedVirusCooldown=0,this.currentViewRadius=0,this.createInitialCell()}isSplitState(t=2,s=.7){if(this.cells.length<=t)return!1;const e=this.findLargestCellMass();return this.totalMass>0&&e/this.totalMass<s}findNearestVulnerableCellToThreat(t,s){let e=null,i=1/0;for(const a of this.cells)if(s>1.15*a.mass){const s=distanceSq(a.x,a.y,t.x,t.y);s<i&&(i=s,e=a)}return{cell:e,distSq:i}}createInitialCell(){let t,s,e=0,i=!1,a=0;const n=canvas?canvas.width:800,r=canvas?canvas.height:600;do{e++,a=getRandomInt(12,18),t=getRandomInt(0,n),s=getRandomInt(0,r),i=!0;for(const e of players)if(e!==this&&!e.isEaten&&0!==e.cells.length){for(const n of e.cells){if(distanceSq(t,s,n.x,n.y)<(n.radius+a+SPAWN_SAFETY_BUFFER)**2){i=!1;break}}if(!i)break}if(i)for(const e of viruses){if(distanceSq(t,s,e.x,e.y)<(e.radius+a+SPAWN_SAFETY_BUFFER)**2){i=!1;break}}}while(!i&&e<100);if(i){const e=new PlayerCell(t,s,a,this);this.addCell(e),this.calculateTotalMass()}else{const t=`LogicalPlayer ${this.name}: Could not find a safe spawn location after ${e} attempts. Map too crowded.`;isGameRunning&&!isResettingGame&&triggerGameReset(t)}}addCell(t){this.cells.push(t)}removeCell(t){const s=this.cells.indexOf(t);s>-1&&this.cells.splice(s,1),this.calculateTotalMass(),0!==this.cells.length||this.isEaten||this.isSplitting||this.markAsEaten()}findLargestCellMass(){return 0===this.cells.length?0:this.cells.reduce(((t,s)=>Math.max(t,s.mass)),0)}calculateTotalMass(){this.totalMass=this.cells.reduce(((t,s)=>t+s.mass),0)}findCenterOfMass(){const t=canvas?canvas.width:800,s=canvas?canvas.height:600;if(0===this.cells.length||this.totalMass<=0)return{x:t/2,y:s/2};let e=0,i=0;this.cells.forEach((t=>{e+=t.x*t.mass,i+=t.y*t.mass}));return{x:this.totalMass>0?e/this.totalMass:this.cells[0]?.x||t/2,y:this.totalMass>0?i/this.totalMass:this.cells[0]?.y||s/2}}findAITarget(){if(this.aiUpdateCooldown=this.aiUpdateInterval,0===this.cells.length)return void(this.aiTarget=null);const t=this.findCenterOfMass(),s=50+Math.sqrt(5*this.totalMass);this.currentViewRadius=s;const e=s*s;let i=null,a=1.2*e,n=null,r=1/0,o=null,l=0,h=null,c=.5*e,d=null,u=e,f=null,x=e,m=null,y=null,g=.3*e,M=null,p=null,v=!1,E=e*.8**2;const T=this.getLargestCell();if(!T)return;const C=T.mass,S=T.radius,R=this.isSplitState(),_=virusRadius*virusRadius*Math.PI*virusSplitMassThresholdMultiplier,A=C<.95*_,P=C>_;let I=!1;for(const s of players){if(s===this||s.isEaten||0===s.cells.length)continue;const i=s.findCenterOfMass(),a=distanceSq(t.x,t.y,i.x,i.y);if(a<e){const h=s.getLargestCell();if(!h)continue;const c=h.mass,y=h.radius,g=s.isSplitState();let P=!1,w=null;if(C>0&&c/C>1.25){if(A&&c>1.1*_)for(const s of viruses){const e=distanceSq(t.x,t.y,s.x,s.y);if(e+distanceSq(s.x,s.y,i.x,i.y)<1.3*a){const a=t.x,n=t.y,r=i.x,o=i.y,l=s.x,h=s.y,c=r-a,d=o-n,u=c*c+d*d;let f=1/0;if(u>.01){const t=((l-a)*c+(h-n)*d)/u;t>=-.1&&t<=1.1&&(f=distanceSq(l,h,a+t*c,n+t*d))}else f=e;if(f<(2*s.radius)**2){P=!0,w=s;break}}}const s=distanceSq(T.x,T.y,h.x,h.y),o=(S+y+25)**2;if(!P){I=!0;const t=Math.min(s,a);t<o&&t<r&&(r=t,n=i)}if(C>=1e4&&!R&&(c>1.1*_&&c>.7*C&&c<100*C&&(a<E||s<(S+y+50)**2)))if(P&&w){distanceSq(T.x,T.y,w.x,w.y)>(T.radius+w.radius+5)**2&&a<E&&(M=i,p=w,v=!0,E=a)}else if(!v&&null==p)for(const s of viruses){if(P&&s===w)continue;const n=distanceSq(T.x,T.y,s.x,s.y);if(n>(T.radius+s.radius+15)**2&&n<e*.8**2*.9){const e=t.x,n=t.y,r=i.x,o=i.y,l=s.x,c=s.y,d=s.radius*s.radius;let u=!1;const f=r-e,x=o-n,m=f*f+x*x;if(m<.001)u=distanceSq(e,n,l,c)<=d;else{const t=((l-e)*f+(c-n)*x)/m;let s,i;t<0?(s=e,i=n):t>1?(s=r,i=o):(s=e+t*f,i=n+t*x);distanceSq(l,c,s,i)<=d&&(u=!0)}const g=distanceSq(h.x,h.y,l,c)<(s.radius+.8*y)**2;if(u&&g&&a<E){M=i,p=s,E=a;break}}}}if(null==p&&null==n){if(C>c/.7){distanceSq(T.x,T.y,h.x,h.y)<2*e&&c>l&&(l=c,o=h)}if(g)for(const t of s.cells)if(C>1.15*t.mass){const s=distanceSq(T.x,T.y,t.x,t.y);s<u&&(!o||s<.8*distanceSq(T.x,T.y,o.x,o.y))&&(u=s,d={x:t.x,y:t.y})}if(R){const t=this.findNearestVulnerableCellToThreat(i,c);if(t.cell){const s=(1.5*y)**2;t.distSq<s&&t.distSq<x&&(x=t.distSq,f=i,m=t.cell)}}}}}if(null==p&&null==n&&null==o&&null==d)for(const t of foods){const s=distanceSq(T.x,T.y,t.x,t.y);s<e&&s<a&&(a=s,i=t)}if(P)for(const t of viruses){if(t===p)continue;const s=distanceSq(T.x,T.y,t.x,t.y);s<(S+t.radius+10)**2&&s<g&&(g=s,y=t)}else if(I)for(const s of viruses){const i=distanceSq(t.x,t.y,s.x,s.y);if(i<.8*e&&i<c){distanceSq(T.x,T.y,s.x,s.y)>(S+s.radius+5)**2&&(c=i,h=s)}}if(n){const e=1.5*S,i=canvas?canvas.width:800,a=canvas?canvas.height:600;let o=!1,l=t.x-n.x,d=t.y-n.y;const u=Math.sqrt(l*l+d*d);if(u>.1&&(l/=u,d/=u),(T.x<e&&l<-.5||T.x>i-e&&l>.5||T.y<e&&d<-.5||T.y>a-e&&d>.5)&&(o=!0),A&&h){if(c<1.2*r){const s=h.x-t.x,e=h.y-t.y;if(s*(t.x-n.x)+e*(t.y-n.y)>0)return void(this.aiTarget={x:h.x,y:h.y,type:"hiding"})}}if(o){const e=Math.atan2(d,l),n=e+Math.PI/2,r=e-Math.PI/2,o=.8*s,h=t.x+Math.cos(n)*o,c=t.y+Math.sin(n)*o,u=t.x+Math.cos(r)*o,f=t.y+Math.sin(r)*o;let x,m;return distanceSq(h,c,i/2,a/2)>=distanceSq(u,f,i/2,a/2)?(x=h,m=c):(x=u,m=f),x=Math.max(S,Math.min(x,i-S)),m=Math.max(S,Math.min(m,a-S)),void(this.aiTarget={x:x,y:m,type:"edgeFleeing"})}const f=Math.atan2(t.y-n.y,t.x-n.x),x=1.1*s;let m=t.x+Math.cos(f)*x,y=t.y+Math.sin(f)*x;return m=Math.max(-50,Math.min(m,i+50)),y=Math.max(-50,Math.min(y,a+50)),void(this.aiTarget={x:m,y:y,type:"fleeing"})}if(y){const t=Math.atan2(T.y-y.y,T.x-y.x);let s=T.x+Math.cos(t)*S*1.5,e=T.y+Math.sin(t)*S*1.5;return s=Math.max(S,Math.min(s,canvas.width-S)),e=Math.max(S,Math.min(e,canvas.height-S)),void(this.aiTarget={x:s,y:e,type:"avoidingVirus"})}if(T.mass>=1e4&&!R&&this.aiFeedVirusCooldown<=0&&null==p){let t=null,s=-1.1;const e=(S+virusRadius+15)**2,i=(S+virusRadius+100)**2;let a=0,n=0,r=!1;if(this.aiTarget){const t=this.aiTarget.x-T.x,s=this.aiTarget.y-T.y,e=t*t+s*s;if(e>1){const i=Math.sqrt(e);a=t/i,n=s/i,r=!0}}for(const o of viruses){const l=distanceSq(T.x,T.y,o.x,o.y);if(l>e&&l<i){if(!r){(null===t||l<distanceSq(T.x,T.y,t.x,t.y))&&(t=o);continue}const e=o.x-T.x,i=o.y-T.y,h=Math.sqrt(l),c=a*(e/h)+n*(i/h);c>.6&&c>s&&(s=c,t=o)}}if(t){const s=.05*T.mass;if(s>=20&&T.mass-s>150&&Math.random()<.3){t.triggerFlash(),feedPellets.push(new FeedPellet(T.x,T.y,t.x,t.y,15,this.color)),T.setMass(T.mass-s),this.calculateTotalMass();const e=Math.atan2(t.y-T.y,t.x-T.x),i=.4*virusRadius;return t.vx=Math.cos(e)*i,t.vy=Math.sin(e)*i,this.aiFeedVirusCooldown=2e4,this.aiTarget=null,void(this.aiUpdateCooldown=0)}}}if(p&&M){const t=.05*T.mass;if(T.mass>=1e4&&t>=20&&T.mass-t>150){p.triggerFlash(),feedPellets.push(new FeedPellet(T.x,T.y,p.x,p.y,15,this.color)),T.setMass(T.mass-t),this.calculateTotalMass();const s=Math.atan2(M.y-p.y,M.x-p.x),e=.4*virusRadius;p.vx=Math.cos(s)*e,p.vy=Math.sin(s)*e}return this.aiTarget=null,void(this.aiUpdateCooldown=0)}if(R&&f&&m)this.aiTarget={x:m.x,y:m.y,type:"protecting"};else if(o)this.aiTarget={x:o.x,y:o.y,type:"huntingLargestPreyCell"};else if(d)this.aiTarget={x:d.x,y:d.y,type:"opportunisticHunt"};else if(i)this.aiTarget={x:i.x,y:i.y,type:"seekingFood"};else if(R&&this.cells.length>1){const t=this.findCenterOfMass();this.aiTarget={x:t.x,y:t.y,type:"mergingAssist"}}else(!this.aiTarget||"fleeing"!==this.aiTarget.type&&"edgeFleeing"!==this.aiTarget.type&&"avoidingVirus"!==this.aiTarget.type&&"protecting"!==this.aiTarget.type&&"huntingLargestPreyCell"!==this.aiTarget.type&&"opportunisticHunt"!==this.aiTarget.type&&"seekingFood"!==this.aiTarget.type&&"mergingAssist"!==this.aiTarget.type)&&(this.aiTarget=null)}getLargestCell(){return 0===this.cells.length?null:this.cells.reduce(((t,s)=>s.mass>t.mass?s:t),this.cells[0])}findLargestCellRadius(){const t=this.getLargestCell();return t?t.radius:0}checkForMerges(){for(let t=this.cells.length-1;t>0;t--)for(let s=t-1;s>=0;s--){if(t>=this.cells.length||s>=this.cells.length)continue;const e=this.cells[t],i=this.cells[s];if(e&&i&&(e.canMerge&&i.canMerge)){const t=distanceSq(e.x,e.y,i.x,i.y),s=.8*(e.radius+i.radius);if(t<s*s){const t=e.mass>=i.mass?e:i,s=e.mass<i.mass?e:i;if(t.setMass(t.mass+s.mass),t.resetMergeTimer(),this.removeCell(s),s===e)break}}}}splitCell(t){if(!this.cells.includes(t)||this.isSplitting||this.isEaten)return;const s=Math.min(7,Math.max(2,Math.floor(t.mass/300)));if(s<2||t.mass<=0)return;const e=t.mass/s;if(e<=0)return;const i=Math.sqrt(e/Math.PI);this.isSplitting=!0;const a=t.x,n=t.y,r=t.radius;this.removeCell(t);const o=[];for(let t=0;t<s;t++){const l=t/s*Math.PI*2+.5*(Math.random()-.5),h=.1*r+1*Math.random();let c=a+Math.cos(l)*(.5*i+1),d=n+Math.sin(l)*(.5*i+1);c=Math.max(i,Math.min(c,canvas.width-i)),d=Math.max(i,Math.min(d,canvas.height-i));const u=new PlayerCell(c,d,i,this);u.setMass(e),u.vx=Math.cos(l)*h,u.vy=Math.sin(l)*h,u.resetMergeTimer(),o.push(u)}this.cells.push(...o),this.isSplitting=!1,this.calculateTotalMass()}applyIntraPlayerRepulsion(){if(!(this.cells.length<2))for(let t=0;t<this.cells.length;t++)for(let s=t+1;s<this.cells.length;s++){const e=this.cells[t],i=this.cells[s];if(!e||!i||e.canMerge&&i.canMerge)continue;const a=i.x-e.x,n=i.y-e.y,r=a*a+n*n,o=1.4*(e.radius+i.radius);if(r<o*o&&r>.001){const t=Math.sqrt(r),s=Math.max(0,1-t/o);let l=.2*s*s;const h=Math.min(e.mergeTimer,i.mergeTimer);let c=1;if(h<=3e3&&h>0){c=1-.95*(1-h/3e3),c=Math.max(.05,c)}else h<=0&&(c=.05);l*=c;const d=a/t,u=n/t,f=l;i.vx+=d*f,i.vy+=u*f,e.vx-=d*f,e.vy-=u*f}}}update(t){if(this.isEaten)return this.respawnTimer-=t,void(this.respawnTimer<=0&&this.respawn());if(0===this.cells.length&&!this.isSplitting)return void this.markAsEaten();this.aiUpdateCooldown-=t,this.aiUpdateCooldown<=0&&this.findAITarget(),this.aiFeedVirusCooldown>0&&(this.aiFeedVirusCooldown-=t),this.applyIntraPlayerRepulsion();const s=this.aiTarget;this.cells.forEach((e=>e.update(t,s))),this.cells.length>1&&this.checkForMerges(),this.calculateTotalMass()}draw(){if([...this.cells].sort(((t,s)=>t.radius-s.radius)).forEach((t=>t.draw())),debug_draw_ai_view&&this.currentViewRadius&&this.currentViewRadius>0&&!this.isEaten){const t=this.findCenterOfMass();ctx.strokeStyle="rgba(255, 255, 0, 0.3)",ctx.lineWidth=1,ctx.beginPath(),ctx.arc(t.x,t.y,this.currentViewRadius,0,2*Math.PI),ctx.stroke(),ctx.closePath(),this.aiTarget&&(ctx.strokeStyle="rgba(255, 0, 255, 0.5)",ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(this.aiTarget.x,this.aiTarget.y),ctx.stroke(),ctx.closePath())}}markAsEaten(){this.isEaten||(this.isEaten=!0,this.respawnTimer=5e3,this.cells=[],this.totalMass=0)}respawn(){this.isEaten=!1,this.isSplitting=!1,this.name=getNextName(),this.color=getRandomColor(),this.aiTarget=null,this.totalMass=0,this.cells=[],this.createInitialCell()}}class PlayerCell{constructor(t,s,e,i){this.parentPlayer=i,this.x=t,this.y=s,this.vx=0,this.vy=0,this.canMerge=!1,this.mergeTimer=12e3,this.mass=0,this.radius=0,this.setRadius(e)}setRadius(t){this.radius=Math.max(0,t),this.mass=Math.PI*this.radius*this.radius}setMass(t){this.mass=Math.max(0,t),this.radius=this.mass>0?Math.sqrt(this.mass/Math.PI):0}setRadiusFromMass(){this.radius=this.mass>0?Math.sqrt(this.mass/Math.PI):0}calculateSpeed(){return Math.max(.2,cellBaseSpeedMultiplier-Math.log1p(1.1*this.radius))}resetMergeTimer(){this.canMerge=!1,this.mergeTimer=12e3}update(t,s){if(this.mass<=0||!this.parentPlayer||this.parentPlayer.isEaten)return void(this.parentPlayer&&!this.parentPlayer.isEaten&&this.parentPlayer.removeCell(this));this.canMerge||(this.mergeTimer-=t,this.mergeTimer<=0&&(this.canMerge=!0));const e=t/16.67,i=this.calculateSpeed();let a,n;s?(a=s.x,n=s.y):(a=this.x+this.vx,n=this.y+this.vy);const r=a-this.x,o=n-this.y;if(r*r+o*o>1){const t=Math.atan2(o,r),s=Math.cos(t)*i,e=Math.sin(t)*i,a=.1;this.vx+=(s-this.vx)*a,this.vy+=(e-this.vy)*a}this.x+=this.vx*e,this.y+=this.vy*e;this.vx*=.98,this.vy*=.98,Math.abs(this.vx)<.01&&Math.abs(this.vy)<.01&&(this.vx=0,this.vy=0);const l=canvas?canvas.width:800,h=canvas?canvas.height:600;this.x=Math.max(0,Math.min(this.x,l)),this.y=Math.max(0,Math.min(this.y,h)),this.setRadiusFromMass()}draw(){if(this.radius<=.5||!this.parentPlayer)return;ctx.fillStyle=this.parentPlayer.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fill(),ctx.closePath();const t=this.parentPlayer.name;if(t&&this.radius>15){ctx.fillStyle="white",ctx.textAlign="center",ctx.textBaseline="middle";const s=.4*this.radius,e=Math.max(10,Math.min(s,24));ctx.font=`bold ${e}px Arial`,ctx.strokeStyle="black",ctx.lineWidth=Math.max(1,.1*e),ctx.strokeText(t,this.x,this.y),ctx.fillText(t,this.x,this.y)}}}class Food{constructor(t,s){this.x=t,this.y=s,this.radius=foodRadius,this.color=getRandomColor(),this.mass=Math.PI*this.radius*this.radius}draw(){ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fillStyle=this.color,ctx.fill(),ctx.closePath()}}class Virus{constructor(t,s){this.x=t,this.y=s,this.radius=virusRadius,this.originalColor="#33ff33",this.color=this.originalColor,this.mass=Math.PI*this.radius*this.radius,this.spikeLength=.2*this.radius,this.spikeCount=10,this.vx=0,this.vy=0,this.isFlashing=!1,this.flashTimer=0,this.flashDuration=150,this.flashColor="#FFFFFF",this.flashInterval=50,this._flashCycleTimer=0}triggerFlash(){this.isFlashing||(this.isFlashing=!0,this.flashTimer=this.flashDuration,this._flashCycleTimer=this.flashInterval,this.color=this.flashColor)}draw(){const t=this.radius+this.spikeLength,s=canvas?canvas.width:800,e=canvas?canvas.height:600;if(!(this.x+t<0||this.x-t>s||this.y+t<0||this.y-t>e)){ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="#2ca32c",ctx.lineWidth=2,ctx.beginPath();for(let t=0;t<this.spikeCount;t++){const s=t/this.spikeCount*Math.PI*2,e=this.x+Math.cos(s)*this.radius*.9,i=this.y+Math.sin(s)*this.radius*.9,a=this.x+Math.cos(s)*(this.radius+this.spikeLength),n=this.y+Math.sin(s)*(this.radius+this.spikeLength);ctx.moveTo(e,i),ctx.lineTo(a,n)}ctx.stroke()}}splitTowards(t,s){const e=Math.atan2(s-this.y,t-this.x),i=.3*virusRadius,a=.8*virusRadius,n=.5*(this.radius+a);let r=this.x+Math.cos(e)*n,o=this.y+Math.sin(e)*n;const l=canvas?canvas.width:800,h=canvas?canvas.height:600;r=Math.max(a,Math.min(r,l-a)),o=Math.max(a,Math.min(o,h-a));const c=new Virus(r,o);return c.radius=a,c.mass=Math.PI*a*a,c.vx=Math.cos(e)*i,c.vy=Math.sin(e)*i,viruses.push(c),!0}update(t){if(this.isFlashing&&(this.flashTimer-=t,this._flashCycleTimer-=t,this._flashCycleTimer<=0&&(this.color=this.color===this.originalColor?this.flashColor:this.originalColor,this._flashCycleTimer=this.flashInterval),this.flashTimer<=0&&(this.isFlashing=!1,this.color=this.originalColor)),0!==this.vx||0!==this.vy){const s=t/16.67;this.x+=this.vx*s,this.y+=this.vy*s;const e=.95;this.vx*=e,this.vy*=e,Math.abs(this.vx)<.1&&Math.abs(this.vy)<.1&&(this.vx=0,this.vy=0);const i=canvas?canvas.width:800,a=canvas?canvas.height:600;this.x=Math.max(this.radius,Math.min(this.x,i-this.radius)),this.y=Math.max(this.radius,Math.min(this.y,a-this.radius))}}}function initGame(){isGameRunning=!0,initAudioContext(),"undefined"!=typeof BACK_GROUHND_MUSIC_BASE64&&BACK_GROUHND_MUSIC_BASE64&&(!backgroundMusicBuffer||audioContext&&!backgroundMusicBuffer.sampleRate?loadAudio(BACK_GROUHND_MUSIC_BASE64).then((t=>{t&&(backgroundMusicBuffer=t,audioContext&&"running"===audioContext.state&&startBackgroundMusic())})).catch((t=>{})):audioContext&&"running"===audioContext.state&&!backgroundMusicSource&&startBackgroundMusic()),document.body.classList.remove("black-background"),gameElementToFade.classList.remove("fade-out"),leaderboardElement.classList.remove("fade-out"),setTimeout((()=>{isPausedForFade=!1}),50),isResettingGame=!1,resizeCanvas(),players=[],foods=[],viruses=[],feedPellets=[],currentNameIndex=0,nextPlayerId=0;for(let t=0;t<initialPlayerCount;t++)players.push(new LogicalPlayer);spawnFood(maxFoodCount),spawnVirus(initialVirusCount),lastTime=performance.now(),requestAnimationFrame(gameLoop)}function triggerGameReset(t){isResettingGame||(isResettingGame=!0,isPausedForFade=!0,isGameRunning=!1,stopBackgroundMusic(),gameElementToFade.classList.add("fade-out"),leaderboardElement.classList.add("fade-out"),setTimeout((()=>{document.body.classList.add("black-background"),setTimeout((()=>{initGame()}),BLACK_SCREEN_DURATION)}),FADE_DURATION))}function spawnFood(t){const s=canvas?canvas.width:800,e=canvas?canvas.height:600;for(let i=0;i<t&&!(foods.length>=maxFoodCount);i++){let t,i,a,n=0;do{a=!1,n++,t=getRandomInt(foodRadius,Math.max(foodRadius,s-foodRadius)),i=getRandomInt(foodRadius,Math.max(foodRadius,e-foodRadius));for(const s of viruses)if(distanceSq(t,i,s.x,s.y)<(s.radius+foodRadius+10)**2){a=!0;break}}while(a&&n<20);a||(foods.push(new Food(t,i)))}}function spawnVirus(t){const s=canvas?canvas.width:800,e=canvas?canvas.height:600;for(let i=0;i<t;i++){let t,i,a,n=0;const r=virusRadius+SPAWN_SAFETY_BUFFER;do{a=!1,n++,t=getRandomInt(r,Math.max(r,s-r)),i=getRandomInt(r,Math.max(r,e-r));for(const s of viruses)if(distanceSq(t,i,s.x,s.y)<(2*virusRadius+SPAWN_SAFETY_BUFFER)**2){a=!0;break}if(!a)for(const s of players)if(!s.isEaten){for(const e of s.cells)if(distanceSq(t,i,e.x,e.y)<(virusRadius+e.radius+SPAWN_SAFETY_BUFFER)**2){a=!0;break}if(a)break}}while(a&&n<30);a||(viruses.push(new Virus(t,i)))}}function checkCollisions(){const t=new Set,s=new Set,e=[],i=new Set,a=[];players.forEach((t=>{t.isEaten||t.cells.forEach((t=>{t&&t.mass>0&&a.push(t)}))}));for(let s=a.length-1;s>=0;s--){const e=a[s];if(!e||i.has(e))continue;const n=e.radius*e.radius;for(let s=foods.length-1;s>=0;s--){if(t.has(s))continue;const i=foods[s];distanceSq(e.x,e.y,i.x,i.y)<n&&(e.setMass(e.mass+i.mass),t.add(s))}}const n=virusRadius*virusRadius*Math.PI*virusSplitMassThresholdMultiplier;for(let t=a.length-1;t>=0;t--){const r=a[t];if(!(!r||i.has(r)||r.mass<=n))for(let t=viruses.length-1;t>=0;t--){if(s.has(t))continue;const i=viruses[t],a=distanceSq(r.x,r.y,i.x,i.y),n=Math.max(0,r.radius-i.radius*VIRUS_SPLIT_DISTANCE_FACTOR);a<n*n&&(e.push({cell:r,virus:i}),s.add(t))}}for(let t=0;t<a.length;t++){const s=a[t];if(s&&!i.has(s)&&s.parentPlayer)for(let e=t+1;e<a.length;e++){const t=a[e];if(!t||i.has(t)||!t.parentPlayer||s.parentPlayer.id===t.parentPlayer.id)continue;const n=distanceSq(s.x,s.y,t.x,t.y),r=s.radius,o=t.radius;if(s.mass>1.15*t.mass){const e=Math.max(0,r-o*PLAYER_EAT_DISTANCE_FACTOR);if(n<e*e){s.setMass(s.mass+t.mass),i.add(t),t.parentPlayer.removeCell(t);continue}}if(t.mass>1.15*s.mass){const e=Math.max(0,o-r*PLAYER_EAT_DISTANCE_FACTOR);if(n<e*e){t.setMass(t.mass+s.mass),i.add(s),s.parentPlayer.removeCell(s);break}}}}t.size>0&&(foods=foods.filter(((s,e)=>!t.has(e)))),s.size>0&&(viruses=viruses.filter(((t,e)=>!s.has(e)))),e.forEach((t=>{t.cell&&!i.has(t.cell)&&t.cell.parentPlayer&&!t.cell.parentPlayer.isEaten&&t.cell.parentPlayer.cells.includes(t.cell)&&t.cell.parentPlayer.splitCell(t.cell)}))}function updateLeaderboard(){if(leaderboardElement)try{const t=players.filter((t=>t&&!t.isEaten&&t.totalMass>0)).sort(((t,s)=>s.totalMass-t.totalMass)).slice(0,10);let s="<h3>Leaderboard</h3><ol>";0===t.length?s+="<li>Waiting for players...</li>":t.forEach(((t,e)=>{const i=Math.round(t.totalMass),a=(t.name||"").replace(/</g,"<").replace(/>/g,">");s+=`<li><span class="leaderboard-rank">${e+1}.</span> <span class="leaderboard-name">${a}</span> <span class="leaderboard-mass">${i}</span></li>`})),s+="</ol>",leaderboardElement.innerHTML=s}catch(t){}}function resizeCanvas(){try{canvas.width=window.innerWidth,canvas.height=window.innerHeight,drawGame()}catch(t){}}function drawGame(){try{ctx.clearRect(0,0,canvas.width,canvas.height),foods.forEach((t=>t.draw())),viruses.forEach((t=>t.draw())),feedPellets.forEach((t=>t.draw())),players.forEach((t=>{t&&!t.isEaten&&t.draw()}))}catch(t){}}function gameLoop(t){if(isPausedForFade||isResettingGame)return void requestAnimationFrame(gameLoop);let s=(t=t||performance.now())-lastTime;s<=0&&(s=16),s=Math.min(s,MAX_DELTA_TIME),lastTime=t;try{if(foods.length<maxFoodCount&&Math.random()<.15&&spawnFood(getRandomInt(2,5)),viruses.length<initialVirusCount&&Math.random()<.01&&spawnVirus(1),players.forEach((t=>t.update(s))),viruses.forEach((t=>t.update(s))),feedPellets=feedPellets.filter((t=>t.update(s))),checkCollisions(),RESET_ON_MAP_COVERAGE&&!isResettingGame){const t=Math.min(canvas.width,canvas.height)*MAP_COVERAGE_RADIUS_FACTOR;let s=!1;for(const e of players){if(e&&!e.isEaten)for(const i of e.cells)if(i.radius>t){triggerGameReset(`Map Coverage! ${e.name} grew too large!`),s=!0;break}if(s)break}if(s)return}const t=players.filter((t=>t&&!t.isEaten)).length,e=MIN_ACTIVE_PLAYERS-t;if(e>0&&!isResettingGame)for(let t=0;t<e;t++)players.push(new LogicalPlayer);leaderboardUpdateCooldown-=s,leaderboardUpdateCooldown<=0&&(updateLeaderboard(),leaderboardUpdateCooldown=LEADERBOARD_UPDATE_INTERVAL),drawGame()}catch(t){return isGameRunning=!1,ctx.fillStyle="red",ctx.font="20px Arial",ctx.textAlign="center",void ctx.fillText("An error occurred. See console.",canvas.width/2,canvas.height/2)}isGameRunning&&requestAnimationFrame(gameLoop)}window.addEventListener("resize",resizeCanvas),document.addEventListener("DOMContentLoaded",(()=>{void 0!==nameList&&Array.isArray(nameList)?shuffleArray(nameList):nameList=["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India","Juliett","Kilo","Lima","Mike","November","Oscar","Papa","Quebec","Romeo","Sierra","Tango","Uniform","Victor","Whiskey","X-ray","Yankee","Zulu"],initGame()}));