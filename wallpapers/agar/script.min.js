const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),leaderboardElement=document.getElementById("leaderboard"),gameContainer=document.getElementById("game-container"),gameElementToFade=gameContainer||canvas;let players=[],foods=[],viruses=[],feedPellets=[],nameList=NAME_LIST,currentNameIndex=0,nextPlayerId=0;const MIN_ACTIVE_PLAYERS=20,initialPlayerCount=MIN_ACTIVE_PLAYERS,maxFoodCount=120,foodRadius=3,initialVirusCount=5,virusRadius=35,virusColor="#33ff33",virusSpikeCount=10,virusSplitMassThresholdMultiplier=1.15,playerSplitPieces=7,playerSplitMinMassPerPiece=100,playerSplitBurstSpeed=1,respawnDelay=5e3,MAX_DELTA_TIME=50,LEADERBOARD_UPDATE_INTERVAL=300,MERGE_COOLDOWN=9e3,FLEE_EDGE_DISTANCE_THRESHOLD=25,PLAYER_EAT_DISTANCE_FACTOR=.4,VIRUS_SPLIT_DISTANCE_FACTOR=.4,MERGE_OVERLAP_FACTOR=.8,INTRA_PLAYER_REPULSION_ENABLED=!0,REPULSION_FORCE_MULTIPLIER=.2,REPULSION_EFFECTIVE_DISTANCE_FACTOR=1.4,REPULSION_MIN_FORCE_FACTOR=.05,REPULSION_FADE_WINDOW_MS=3e3,AI_CAN_FEED_VIRUS=!0,MIN_MASS_TO_FEED_VIRUS=1e4,VIRUS_FEED_MASS_COST=1e3,VIRUS_MAX_FEED_COUNT=7,FEED_VIRUS_RANGE_FACTOR=.8,FEED_TARGET_MAX_MASS_FACTOR=100,FEED_EDGE_PROXIMITY_THRESHOLD=50,PELLET_SPEED=15,PELLET_LIFESPAN=300,PELLET_RADIUS=15,MAX_SPAWN_ATTEMPTS=100,SPAWN_SAFETY_BUFFER=15;let cellBaseSpeedMultiplier=6;const CELL_SPEED_MASS_FACTOR=1.1,RESET_ON_MAP_COVERAGE=!0,MAP_COVERAGE_RADIUS_FACTOR=.85,INTRA_PLAYER_COLLISION_ENABLED=!0,FADE_DURATION=2e3,BLACK_SCREEN_DURATION=500;let leaderboardUpdateCooldown=LEADERBOARD_UPDATE_INTERVAL,lastTime=0,isPausedForFade=!1,isResettingGame=!1,isGameRunning=!1,audioContext=null,backgroundMusicBuffer=null,backgroundMusicSource=null;function getRandomColor(){let t="#";do{t="#";const s="0123456789ABCDEF";for(let e=0;e<6;e++)t+=s[Math.floor(16*Math.random())]}while(parseInt(t.substring(1,3),16)<100&&parseInt(t.substring(3,5),16)>150&&parseInt(t.substring(5,7),16)<100);return t}function getRandomInt(t,s){return Math.floor(Math.random()*(s-t+1))+t}function distanceSq(t,s,e,a){const i=e-t,n=a-s;return i*i+n*n}function shuffleArray(t){if(t&&0!==t.length)for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}}function getNextName(){if(!nameList||0===nameList.length)return`Cell_${Math.floor(1e3*Math.random())}`;const t=nameList[currentNameIndex];return currentNameIndex=(currentNameIndex+1)%nameList.length,t}async function base64ToArrayBuffer(t){try{const s=t.split(",")[1]||t,e=window.atob(s),a=e.length,i=new Uint8Array(a);for(let t=0;t<a;t++)i[t]=e.charCodeAt(t);return i.buffer}catch(t){throw t}}async function loadAudio(t){if(!audioContext)return null;if(!t)return null;try{const s=await base64ToArrayBuffer(t);return await audioContext.decodeAudioData(s)}catch(t){return null}}function startBackgroundMusic(){if(audioContext)if("suspended"!==audioContext.state){if(backgroundMusicBuffer){if(backgroundMusicSource){try{backgroundMusicSource.stop()}catch(t){}try{backgroundMusicSource.disconnect()}catch(t){}backgroundMusicSource=null}try{backgroundMusicSource=audioContext.createBufferSource(),backgroundMusicSource.buffer=backgroundMusicBuffer,backgroundMusicSource.loop=!0,backgroundMusicSource.connect(audioContext.destination),backgroundMusicSource.start(0)}catch(t){backgroundMusicSource=null}}}else audioContext.resume().catch((t=>{}))}function stopBackgroundMusic(){if(backgroundMusicSource){try{backgroundMusicSource.stop(),backgroundMusicSource.disconnect()}catch(t){}backgroundMusicSource=null}}function initAudioContext(){if(!audioContext)try{if(audioContext=new(window.AudioContext||window.webkitAudioContext),"suspended"===audioContext.state){let t=!1;const s=()=>{t&&(audioContext&&"suspended"===audioContext.state&&audioContext.resume().then((()=>{isGameRunning&&backgroundMusicBuffer&&!backgroundMusicSource&&startBackgroundMusic()})).catch((t=>{})),document.body.removeEventListener("click",s),document.body.removeEventListener("keydown",s),t=!1)};t||(document.body.addEventListener("click",s,{once:!0}),document.body.addEventListener("keydown",s,{once:!0}),t=!0)}}catch(t){audioContext=null}}window.wallpaperPropertyListener={applyUserProperties:function(t){t.cellbasespeed&&(cellBaseSpeedMultiplier=t.cellbasespeed.value)}};class FeedPellet{constructor(t,s,e,a,i,n){this.x=t,this.y=s,this.radius=i,this.color=n,this.lifeTimer=300;const r=e-t,o=a-s,l=Math.sqrt(r*r+o*o);l>.1?(this.vx=r/l*15,this.vy=o/l*15):(this.vx=15*(Math.random()-.5)*.1,this.vy=15*(Math.random()-.5)*.1)}update(t){const s=t/16.67;return this.x+=this.vx*s,this.y+=this.vy*s,this.lifeTimer-=t,this.lifeTimer>0}draw(){const t=Math.max(0,Math.min(1,this.lifeTimer/300));let s=this.color;try{if(this.color.startsWith("#")&&7===this.color.length){const e=Math.floor(255*t).toString(16).padStart(2,"0");s=this.color+e,ctx.fillStyle=s}else ctx.globalAlpha=t,ctx.fillStyle=this.color;ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fill(),ctx.closePath()}catch(t){}finally{ctx.globalAlpha=1}}}class LogicalPlayer{constructor(t,s){this.id=nextPlayerId++,this.name=t||getNextName(),this.color=s||getRandomColor(),this.cells=[],this.totalMass=0,this.isEaten=!1,this.respawnTimer=0,this.isSplitting=!1,this.aiTarget=null,this.aiUpdateCooldown=200*Math.random(),this.aiUpdateInterval=200+150*Math.random(),this.createInitialCell()}isSplitState(t=2,s=.7){if(this.cells.length<=t)return!1;const e=this.findLargestCellMass();return this.totalMass>0&&e/this.totalMass<s}findNearestVulnerableCellToThreat(t,s){let e=null,a=1/0;for(const i of this.cells)if(s>1.15*i.mass){const s=distanceSq(i.x,i.y,t.x,t.y);s<a&&(a=s,e=i)}return{cell:e,distSq:a}}createInitialCell(){let t,s,e=0,a=!1,i=0;const n=canvas?canvas.width:800,r=canvas?canvas.height:600;do{e++,i=getRandomInt(12,18),t=getRandomInt(0,n),s=getRandomInt(0,r),a=!0;for(const e of players)if(e!==this&&!e.isEaten&&0!==e.cells.length){for(const n of e.cells){if(distanceSq(t,s,n.x,n.y)<(n.radius+i+SPAWN_SAFETY_BUFFER)**2){a=!1;break}}if(!a)break}if(a)for(const e of viruses){if(distanceSq(t,s,e.x,e.y)<(e.radius+i+SPAWN_SAFETY_BUFFER)**2){a=!1;break}}}while(!a&&e<100);if(a){const e=new PlayerCell(t,s,i,this);this.addCell(e),this.calculateTotalMass()}else{const t=`LogicalPlayer ${this.name}: Could not find a safe spawn location after ${e} attempts. Map too crowded.`;isGameRunning&&!isResettingGame&&triggerGameReset(t)}}addCell(t){this.cells.push(t)}removeCell(t){const s=this.cells.indexOf(t);s>-1&&this.cells.splice(s,1),this.calculateTotalMass(),0!==this.cells.length||this.isEaten||this.isSplitting||this.markAsEaten()}findLargestCellMass(){return 0===this.cells.length?0:this.cells.reduce(((t,s)=>Math.max(t,s.mass)),0)}calculateTotalMass(){this.totalMass=this.cells.reduce(((t,s)=>t+s.mass),0)}findCenterOfMass(){const t=canvas?canvas.width:800,s=canvas?canvas.height:600;if(0===this.cells.length||this.totalMass<=0)return{x:t/2,y:s/2};let e=0,a=0;this.cells.forEach((t=>{e+=t.x*t.mass,a+=t.y*t.mass}));return{x:this.totalMass>0?e/this.totalMass:this.cells[0]?.x||t/2,y:this.totalMass>0?a/this.totalMass:this.cells[0]?.y||s/2}}findAITarget(){if(this.aiUpdateCooldown=this.aiUpdateInterval,0===this.cells.length)return void(this.aiTarget=null);const t=this.findCenterOfMass(),s=300+50*Math.log1p(this.totalMass),e=s*s;let a=null,i=1.2*e,n=null,r=1/0,o=null,l=e,h=null,c=.5*e,d=null,u=e,f=null,m=e,x=null,M=null,g=.3*e,y=null,p=null,E=!1,v=e*.8**2;const S=this.getLargestCell();if(!S)return;const C=S.mass,T=S.radius,A=this.isSplitState(),R=virusRadius*virusRadius*Math.PI*virusSplitMassThresholdMultiplier,_=C<.95*R,P=C>R;let I=!1;for(const s of players){if(s===this||s.isEaten||0===s.cells.length)continue;const a=s.findCenterOfMass(),i=distanceSq(t.x,t.y,a.x,a.y);if(i<e){const h=s.findLargestCellMass(),c=s.findLargestCellRadius(),M=s.isSplitState();let g=!1,P=null;if(C>0&&h/C>1.25){if(_&&h>1.1*R)for(const s of viruses){const e=distanceSq(t.x,t.y,s.x,s.y);if(e+distanceSq(s.x,s.y,a.x,a.y)<1.3*i){const i=t.x,n=t.y,r=a.x,o=a.y,l=s.x,h=s.y,c=r-i,d=o-n,u=c*c+d*d;let f=1/0;if(u>.01){const t=((l-i)*c+(h-n)*d)/u;t>=-.1&&t<=1.1&&(f=distanceSq(l,h,i+t*c,n+t*d))}else f=e;if(f<(2*s.radius)**2){g=!0,P=s;break}}}g||(I=!0,i<(T+c+25)**2&&i<r&&(r=i,n=a));if(C>=1e4&&!A&&(h>1.1*R&&h>.7*C&&h<100*C&&(i<v||i<(T+c+50)**2)))if(g&&P){distanceSq(S.x,S.y,P.x,P.y)>(S.radius+P.radius+5)**2&&i<v&&(y=a,p=P,E=!0,v=i)}else if(!E&&null==p)for(const s of viruses){if(g&&s===P)continue;const n=distanceSq(S.x,S.y,s.x,s.y);if(n>(S.radius+s.radius+15)**2&&n<e*.8**2*.9){const e=t.x,n=t.y,r=a.x,o=a.y,l=s.x,h=s.y;let d=1/0;const u=(r-e)**2+(o-n)**2;if(u>.01){const t=((l-e)*(r-e)+(h-n)*(o-n))/u;d=t>=-.1&&t<=1.1?distanceSq(l,h,e+t*(r-e),n+t*(o-n)):Math.min(distanceSq(l,h,e,n),distanceSq(l,h,r,o))}else d=distanceSq(l,h,e,n);const f=d<(2.5*s.radius)**2,m=distanceSq(r,o,l,h)<(s.radius+.8*c)**2;if(f&&m&&i<v){y=a,p=s,v=i;break}}}}if(null==p&&null==n){if(C>1.3*h&&i<l&&(l=i,o=a),M)for(const t of s.cells)if(C>1.15*t.mass){const s=distanceSq(S.x,S.y,t.x,t.y);s<u&&s<.8*l&&(u=s,d={x:t.x,y:t.y})}if(A){const t=this.findNearestVulnerableCellToThreat(a,h);if(t.cell){const s=(1.5*c)**2;t.distSq<s&&t.distSq<m&&(m=t.distSq,f=a,x=t.cell)}}}}}if(null==p&&null==n&&null==o&&null==d)for(const t of foods){const s=distanceSq(S.x,S.y,t.x,t.y);s<e&&s<i&&(i=s,a=t)}if(P)for(const t of viruses){if(t===p)continue;const s=distanceSq(S.x,S.y,t.x,t.y);s<(T+t.radius+10)**2&&s<g&&(g=s,M=t)}else if(I)for(const s of viruses){const a=distanceSq(t.x,t.y,s.x,s.y);if(a<.8*e&&a<c){distanceSq(S.x,S.y,s.x,s.y)>(T+s.radius+5)**2&&(c=a,h=s)}}if(n){if(_&&h){if(c<r){const s=h.x-t.x,e=h.y-t.y;if(s*(t.x-n.x)+e*(t.y-n.y)>0)return void(this.aiTarget={x:h.x,y:h.y,type:"hiding"})}}const e=Math.atan2(t.y-n.y,t.x-n.x),a=1.1*s;let i=t.x+Math.cos(e)*a,o=t.y+Math.sin(e)*a;return i=Math.max(-50,Math.min(i,canvas.width+50)),o=Math.max(-50,Math.min(o,canvas.height+50)),void(this.aiTarget={x:i,y:o,type:"fleeing"})}if(M){const t=Math.atan2(S.y-M.y,S.x-M.x);let s=S.x+Math.cos(t)*T*1.5,e=S.y+Math.sin(t)*T*1.5;return s=Math.max(T,Math.min(s,canvas.width-T)),e=Math.max(T,Math.min(e,canvas.height-T)),void(this.aiTarget={x:s,y:e,type:"avoidingVirus"})}if(p&&y){if(S.mass>=1e4&&(p.triggerFlash(),feedPellets.push(new FeedPellet(S.x,S.y,p.x,p.y,15,this.color)),S.setMass(S.mass-1e3),this.calculateTotalMass(),p.feedCount++,p.feedCount>=7&&p.splitTowards(y.x,y.y))){const t=viruses.indexOf(p);t>-1&&viruses.splice(t,1)}return this.aiTarget=null,void(this.aiUpdateCooldown=0)}if(A&&f&&x)return void(this.aiTarget={x:x.x,y:x.y,type:"protecting"});if(d)return void(this.aiTarget={x:d.x,y:d.y,type:"opportunisticHunt"});if(o)return void(this.aiTarget={x:o.x,y:o.y,type:"hunting"});if(a)return void(this.aiTarget={x:a.x,y:a.y,type:"seekingFood"});if(A&&this.cells.length>1){const t=this.findCenterOfMass();return void(this.aiTarget={x:t.x,y:t.y,type:"mergingAssist"})}const w=this.aiTarget?distanceSq(t.x,t.y,this.aiTarget.x,this.aiTarget.y):1/0;if(!this.aiTarget||"wandering"===this.aiTarget.type&&w<22500){const s=Math.random()*Math.PI*2,e=200+300*Math.random();let a=t.x+Math.cos(s)*e,i=t.y+Math.sin(s)*e;a=Math.max(50,Math.min(a,canvas.width-50)),i=Math.max(50,Math.min(i,canvas.height-50)),this.aiTarget={x:a,y:i,type:"wandering"}}}getLargestCell(){return 0===this.cells.length?null:this.cells.reduce(((t,s)=>s.mass>t.mass?s:t),this.cells[0])}findLargestCellRadius(){const t=this.getLargestCell();return t?t.radius:0}checkForMerges(){for(let t=this.cells.length-1;t>0;t--)for(let s=t-1;s>=0;s--){if(t>=this.cells.length||s>=this.cells.length)continue;const e=this.cells[t],a=this.cells[s];if(e&&a&&(e.canMerge&&a.canMerge)){const t=distanceSq(e.x,e.y,a.x,a.y),s=.8*(e.radius+a.radius);if(t<s*s){const t=e.mass>=a.mass?e:a,s=e.mass<a.mass?e:a;if(t.setMass(t.mass+s.mass),t.resetMergeTimer(),this.removeCell(s),s===e)break}}}}splitCell(t){if(!this.cells.includes(t)||this.isSplitting||this.isEaten)return;const s=Math.min(7,Math.max(2,Math.floor(t.mass/100)));if(s<2||t.mass<=0)return;const e=t.mass/s;if(e<=0)return;const a=Math.sqrt(e/Math.PI);this.isSplitting=!0;const i=t.x,n=t.y,r=t.radius;this.removeCell(t);const o=[];for(let t=0;t<s;t++){const l=t/s*Math.PI*2+.5*(Math.random()-.5),h=.1*r+1*Math.random();let c=i+Math.cos(l)*(.5*a+1),d=n+Math.sin(l)*(.5*a+1);c=Math.max(a,Math.min(c,canvas.width-a)),d=Math.max(a,Math.min(d,canvas.height-a));const u=new PlayerCell(c,d,a,this);u.setMass(e),u.vx=Math.cos(l)*h,u.vy=Math.sin(l)*h,u.resetMergeTimer(),o.push(u)}this.cells.push(...o),this.isSplitting=!1,this.calculateTotalMass()}applyIntraPlayerRepulsion(){if(!(this.cells.length<2))for(let t=0;t<this.cells.length;t++)for(let s=t+1;s<this.cells.length;s++){const e=this.cells[t],a=this.cells[s];if(!e||!a||e.canMerge&&a.canMerge)continue;const i=a.x-e.x,n=a.y-e.y,r=i*i+n*n,o=1.4*(e.radius+a.radius);if(r<o*o&&r>.001){const t=Math.sqrt(r),s=Math.max(0,1-t/o);let l=.2*s*s;const h=Math.min(e.mergeTimer,a.mergeTimer);let c=1;if(h<=3e3&&h>0){c=1-.95*(1-h/3e3),c=Math.max(.05,c)}else h<=0&&(c=.05);l*=c;const d=i/t,u=n/t,f=l;a.vx+=d*f,a.vy+=u*f,e.vx-=d*f,e.vy-=u*f}}}update(t){if(this.isEaten)return this.respawnTimer-=t,void(this.respawnTimer<=0&&this.respawn());if(0===this.cells.length&&!this.isSplitting)return void this.markAsEaten();this.aiUpdateCooldown-=t,this.aiUpdateCooldown<=0&&this.findAITarget(),this.applyIntraPlayerRepulsion();const s=this.aiTarget;this.cells.forEach((e=>e.update(t,s))),this.cells.length>1&&this.checkForMerges(),this.calculateTotalMass()}draw(){[...this.cells].sort(((t,s)=>t.radius-s.radius)).forEach((t=>t.draw()))}markAsEaten(){this.isEaten||(this.isEaten=!0,this.respawnTimer=5e3,this.cells=[],this.totalMass=0)}respawn(){this.isEaten=!1,this.isSplitting=!1,this.name=getNextName(),this.color=getRandomColor(),this.aiTarget=null,this.totalMass=0,this.cells=[],this.createInitialCell()}}class PlayerCell{constructor(t,s,e,a){this.parentPlayer=a,this.x=t,this.y=s,this.vx=0,this.vy=0,this.canMerge=!1,this.mergeTimer=9e3,this.mass=0,this.radius=0,this.setRadius(e)}setRadius(t){this.radius=Math.max(0,t),this.mass=Math.PI*this.radius*this.radius}setMass(t){this.mass=Math.max(0,t),this.radius=this.mass>0?Math.sqrt(this.mass/Math.PI):0}setRadiusFromMass(){this.radius=this.mass>0?Math.sqrt(this.mass/Math.PI):0}calculateSpeed(){return Math.max(.2,cellBaseSpeedMultiplier-Math.log1p(1.1*this.radius))}resetMergeTimer(){this.canMerge=!1,this.mergeTimer=9e3}update(t,s){if(this.mass<=0||!this.parentPlayer||this.parentPlayer.isEaten)return void(this.parentPlayer&&!this.parentPlayer.isEaten&&this.parentPlayer.removeCell(this));this.canMerge||(this.mergeTimer-=t,this.mergeTimer<=0&&(this.canMerge=!0));const e=t/16.67,a=this.calculateSpeed();let i,n;s?(i=s.x,n=s.y):(i=this.x+this.vx,n=this.y+this.vy);const r=i-this.x,o=n-this.y;if(r*r+o*o>1){const t=Math.atan2(o,r),s=Math.cos(t)*a,e=Math.sin(t)*a,i=.1;this.vx+=(s-this.vx)*i,this.vy+=(e-this.vy)*i}this.x+=this.vx*e,this.y+=this.vy*e;this.vx*=.98,this.vy*=.98,Math.abs(this.vx)<.01&&Math.abs(this.vy)<.01&&(this.vx=0,this.vy=0);const l=canvas?canvas.width:800,h=canvas?canvas.height:600;this.x=Math.max(0,Math.min(this.x,l)),this.y=Math.max(0,Math.min(this.y,h)),this.setRadiusFromMass()}draw(){if(this.radius<=.5||!this.parentPlayer)return;ctx.fillStyle=this.parentPlayer.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fill(),ctx.closePath();const t=this.parentPlayer.name;if(t&&this.radius>15){ctx.fillStyle="white",ctx.textAlign="center",ctx.textBaseline="middle";const s=.4*this.radius,e=Math.max(10,Math.min(s,24));ctx.font=`bold ${e}px Arial`,ctx.strokeStyle="black",ctx.lineWidth=Math.max(1,.1*e),ctx.strokeText(t,this.x,this.y),ctx.fillText(t,this.x,this.y)}}}class Food{constructor(t,s){this.x=t,this.y=s,this.radius=foodRadius,this.color=getRandomColor(),this.mass=Math.PI*this.radius*this.radius}draw(){ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fillStyle=this.color,ctx.fill(),ctx.closePath()}}class Virus{constructor(t,s){this.x=t,this.y=s,this.radius=virusRadius,this.originalColor="#33ff33",this.color=this.originalColor,this.feedCount=0,this.mass=Math.PI*this.radius*this.radius,this.spikeLength=.2*this.radius,this.spikeCount=10,this.vx=0,this.vy=0,this.isFlashing=!1,this.flashTimer=0,this.flashDuration=150,this.flashColor="#FFFFFF",this.flashInterval=50,this._flashCycleTimer=0}triggerFlash(){this.isFlashing||(this.isFlashing=!0,this.flashTimer=this.flashDuration,this._flashCycleTimer=this.flashInterval,this.color=this.flashColor)}draw(){const t=this.radius+this.spikeLength,s=canvas?canvas.width:800,e=canvas?canvas.height:600;if(!(this.x+t<0||this.x-t>s||this.y+t<0||this.y-t>e)){ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="#2ca32c",ctx.lineWidth=2,ctx.beginPath();for(let t=0;t<this.spikeCount;t++){const s=t/this.spikeCount*Math.PI*2,e=this.x+Math.cos(s)*this.radius*.9,a=this.y+Math.sin(s)*this.radius*.9,i=this.x+Math.cos(s)*(this.radius+this.spikeLength),n=this.y+Math.sin(s)*(this.radius+this.spikeLength);ctx.moveTo(e,a),ctx.lineTo(i,n)}ctx.stroke()}}splitTowards(t,s){const e=Math.atan2(s-this.y,t-this.x),a=.3*virusRadius,i=.8*virusRadius,n=.5*(this.radius+i);let r=this.x+Math.cos(e)*n,o=this.y+Math.sin(e)*n;const l=canvas?canvas.width:800,h=canvas?canvas.height:600;r=Math.max(i,Math.min(r,l-i)),o=Math.max(i,Math.min(o,h-i));const c=new Virus(r,o);return c.radius=i,c.mass=Math.PI*i*i,c.vx=Math.cos(e)*a,c.vy=Math.sin(e)*a,viruses.push(c),!0}update(t){if(this.isFlashing&&(this.flashTimer-=t,this._flashCycleTimer-=t,this._flashCycleTimer<=0&&(this.color=this.color===this.originalColor?this.flashColor:this.originalColor,this._flashCycleTimer=this.flashInterval),this.flashTimer<=0&&(this.isFlashing=!1,this.color=this.originalColor)),0!==this.vx||0!==this.vy){const s=t/16.67;this.x+=this.vx*s,this.y+=this.vy*s;const e=.95;this.vx*=e,this.vy*=e,Math.abs(this.vx)<.1&&Math.abs(this.vy)<.1&&(this.vx=0,this.vy=0);const a=canvas?canvas.width:800,i=canvas?canvas.height:600;this.x=Math.max(0,Math.min(this.x,a)),this.y=Math.max(0,Math.min(this.y,i))}}}function initGame(){isGameRunning=!0,initAudioContext(),"undefined"!=typeof BACK_GROUHND_MUSIC_BASE64&&BACK_GROUHND_MUSIC_BASE64&&(!backgroundMusicBuffer||audioContext&&!backgroundMusicBuffer.sampleRate?loadAudio(BACK_GROUHND_MUSIC_BASE64).then((t=>{t&&(backgroundMusicBuffer=t,audioContext&&"running"===audioContext.state&&startBackgroundMusic())})).catch((t=>{})):audioContext&&"running"===audioContext.state&&!backgroundMusicSource&&startBackgroundMusic()),document.body.classList.remove("black-background"),gameElementToFade.classList.remove("fade-out"),leaderboardElement.classList.remove("fade-out"),setTimeout((()=>{isPausedForFade=!1}),50),isResettingGame=!1,resizeCanvas(),players=[],foods=[],viruses=[],feedPellets=[],currentNameIndex=0,nextPlayerId=0;for(let t=0;t<initialPlayerCount;t++)players.push(new LogicalPlayer);spawnFood(maxFoodCount),spawnVirus(initialVirusCount),lastTime=performance.now(),requestAnimationFrame(gameLoop)}function triggerGameReset(t){isResettingGame||(isResettingGame=!0,isPausedForFade=!0,isGameRunning=!1,stopBackgroundMusic(),gameElementToFade.classList.add("fade-out"),leaderboardElement.classList.add("fade-out"),setTimeout((()=>{document.body.classList.add("black-background"),setTimeout((()=>{initGame()}),BLACK_SCREEN_DURATION)}),FADE_DURATION))}function spawnFood(t){const s=canvas?canvas.width:800,e=canvas?canvas.height:600;for(let a=0;a<t&&!(foods.length>=maxFoodCount);a++){let t,a,i,n=0;do{i=!1,n++,t=getRandomInt(foodRadius,Math.max(foodRadius,s-foodRadius)),a=getRandomInt(foodRadius,Math.max(foodRadius,e-foodRadius));for(const s of viruses)if(distanceSq(t,a,s.x,s.y)<(s.radius+foodRadius+10)**2){i=!0;break}}while(i&&n<20);i||(foods.push(new Food(t,a)))}}function spawnVirus(t){const s=canvas?canvas.width:800,e=canvas?canvas.height:600;for(let a=0;a<t;a++){let t,a,i,n=0;const r=virusRadius+SPAWN_SAFETY_BUFFER;do{i=!1,n++,t=getRandomInt(r,Math.max(r,s-r)),a=getRandomInt(r,Math.max(r,e-r));for(const s of viruses)if(distanceSq(t,a,s.x,s.y)<(2*virusRadius+SPAWN_SAFETY_BUFFER)**2){i=!0;break}if(!i)for(const s of players)if(!s.isEaten){for(const e of s.cells)if(distanceSq(t,a,e.x,e.y)<(virusRadius+e.radius+SPAWN_SAFETY_BUFFER)**2){i=!0;break}if(i)break}}while(i&&n<30);i||(viruses.push(new Virus(t,a)))}}function checkCollisions(){const t=new Set,s=new Set,e=[],a=new Set,i=[];players.forEach((t=>{t.isEaten||t.cells.forEach((t=>{t&&t.mass>0&&i.push(t)}))}));for(let s=i.length-1;s>=0;s--){const e=i[s];if(!e||a.has(e))continue;const n=e.radius*e.radius;for(let s=foods.length-1;s>=0;s--){if(t.has(s))continue;const a=foods[s];distanceSq(e.x,e.y,a.x,a.y)<n&&(e.setMass(e.mass+a.mass),t.add(s))}}const n=virusRadius*virusRadius*Math.PI*virusSplitMassThresholdMultiplier;for(let t=i.length-1;t>=0;t--){const r=i[t];if(!(!r||a.has(r)||r.mass<=n))for(let t=viruses.length-1;t>=0;t--){if(s.has(t))continue;const a=viruses[t],i=distanceSq(r.x,r.y,a.x,a.y),n=Math.max(0,r.radius-a.radius*VIRUS_SPLIT_DISTANCE_FACTOR);i<n*n&&(e.push({cell:r,virus:a}),s.add(t))}}for(let t=0;t<i.length;t++){const s=i[t];if(s&&!a.has(s)&&s.parentPlayer)for(let e=t+1;e<i.length;e++){const t=i[e];if(!t||a.has(t)||!t.parentPlayer||s.parentPlayer.id===t.parentPlayer.id)continue;const n=distanceSq(s.x,s.y,t.x,t.y),r=s.radius,o=t.radius;if(s.mass>1.15*t.mass){const e=Math.max(0,r-o*PLAYER_EAT_DISTANCE_FACTOR);if(n<e*e){s.setMass(s.mass+t.mass),a.add(t),t.parentPlayer.removeCell(t);continue}}if(t.mass>1.15*s.mass){const e=Math.max(0,o-r*PLAYER_EAT_DISTANCE_FACTOR);if(n<e*e){t.setMass(t.mass+s.mass),a.add(s),s.parentPlayer.removeCell(s);break}}}}t.size>0&&(foods=foods.filter(((s,e)=>!t.has(e)))),s.size>0&&(viruses=viruses.filter(((t,e)=>!s.has(e)))),e.forEach((t=>{t.cell&&!a.has(t.cell)&&t.cell.parentPlayer&&!t.cell.parentPlayer.isEaten&&t.cell.parentPlayer.cells.includes(t.cell)&&t.cell.parentPlayer.splitCell(t.cell)}))}function updateLeaderboard(){if(leaderboardElement)try{const t=players.filter((t=>t&&!t.isEaten&&t.totalMass>0)).sort(((t,s)=>s.totalMass-t.totalMass)).slice(0,10);let s="<h3>Leaderboard</h3><ol>";0===t.length?s+="<li>Waiting for players...</li>":t.forEach(((t,e)=>{const a=Math.round(t.totalMass),i=(t.name||"").replace(/</g,"<").replace(/>/g,">");s+=`<li><span class="leaderboard-rank">${e+1}.</span> <span class="leaderboard-name">${i}</span> <span class="leaderboard-mass">${a}</span></li>`})),s+="</ol>",leaderboardElement.innerHTML=s}catch(t){}}function resizeCanvas(){try{canvas.width=window.innerWidth,canvas.height=window.innerHeight,drawGame()}catch(t){}}function drawGame(){try{ctx.clearRect(0,0,canvas.width,canvas.height),foods.forEach((t=>t.draw())),viruses.forEach((t=>t.draw())),feedPellets.forEach((t=>t.draw())),players.forEach((t=>{t&&!t.isEaten&&t.draw()}))}catch(t){}}function gameLoop(t){if(isPausedForFade||isResettingGame)return void requestAnimationFrame(gameLoop);let s=(t=t||performance.now())-lastTime;s<=0&&(s=16),s=Math.min(s,MAX_DELTA_TIME),lastTime=t;try{if(foods.length<maxFoodCount&&Math.random()<.1&&spawnFood(getRandomInt(1,3)),viruses.length<initialVirusCount&&Math.random()<.01&&spawnVirus(1),players.forEach((t=>t.update(s))),viruses.forEach((t=>t.update(s))),feedPellets=feedPellets.filter((t=>t.update(s))),checkCollisions(),RESET_ON_MAP_COVERAGE&&!isResettingGame){const t=Math.min(canvas.width,canvas.height)*MAP_COVERAGE_RADIUS_FACTOR;let s=!1;for(const e of players){if(e&&!e.isEaten)for(const a of e.cells)if(a.radius>t){triggerGameReset(`Map Coverage! ${e.name} grew too large!`),s=!0;break}if(s)break}if(s)return}const t=players.filter((t=>t&&!t.isEaten)).length,e=MIN_ACTIVE_PLAYERS-t;if(e>0&&!isResettingGame)for(let t=0;t<e;t++)players.push(new LogicalPlayer);leaderboardUpdateCooldown-=s,leaderboardUpdateCooldown<=0&&(updateLeaderboard(),leaderboardUpdateCooldown=LEADERBOARD_UPDATE_INTERVAL),drawGame()}catch(t){return isGameRunning=!1,ctx.fillStyle="red",ctx.font="20px Arial",ctx.textAlign="center",void ctx.fillText("An error occurred. See console.",canvas.width/2,canvas.height/2)}isGameRunning&&requestAnimationFrame(gameLoop)}window.addEventListener("resize",resizeCanvas),document.addEventListener("DOMContentLoaded",(()=>{void 0!==nameList&&Array.isArray(nameList)?shuffleArray(nameList):nameList=["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India","Juliett","Kilo","Lima","Mike","November","Oscar","Papa","Quebec","Romeo","Sierra","Tango","Uniform","Victor","Whiskey","X-ray","Yankee","Zulu"],initGame()}));