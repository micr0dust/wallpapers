let scene,camera,renderer,clock,roadSegments=[],terrainSegments=[],pillars=[],embankmentSegments=[],guardrailSegments=[],treeInstances=[];const segmentLength=40,roadWidth=8,numSegments=30,terrainWidth=600,terrainDetail=38;let audioContext,driveSpeed=15,currentPathDistance=0,isPaused=!1,animationFrameId=null,engineSoundBuffer=null,musicSoundBuffer=null,ambientSoundBuffer=null,engineSourceNode=null,musicSourceNode=null,ambientSourceNode=null,engineGainNode=null,musicGainNode=null,ambientGainNode=null,isEngineReady=!1,isMusicReady=!1,isAmbientReady=!1,currentEnginePitch=1,currentEngineVolume=.8;const baseEngineVolume=.8,musicVolume=.4,ambientVolume=.6,pitchChangeSpeed=1.5,volumeChangeSpeed=2;let hasAudioStarted=!1;const engineBase64="undefined"!=typeof ENGINE_LOOP_BASE64?ENGINE_LOOP_BASE64:null,musicBase64="undefined"!=typeof BACK_GROUHND_MUSIC_BASE64?BACK_GROUHND_MUSIC_BASE64:null,ambientBase64="undefined"!=typeof STRONG_WIND_BASE64?STRONG_WIND_BASE64:null,simplex=new SimplexNoise,baseTerrainHeightFreq=.003,baseTerrainHeightAmp=60,roadHeightVariationFreq=.015,roadHeightVariationAmp=8,curveFrequency=.005,curveAmplitude=80,terrainFrequency=.008,terrainAmplitude=55,cameraHeight=3.5,cameraLookDistance=45,cameraFollowSpeed=.06,rightLaneOffset=.25*roadWidth;let targetCameraPosition=new THREE.Vector3,targetLookAtPosition=new THREE.Vector3;const pillarCheckThreshold=4,pillarSpacing=8,pillarRadius=.5,pillarMaterial=new THREE.MeshStandardMaterial({color:8947848}),roadBedOffset=-2,roadForceRadius=.7*roadWidth,roadBlendRadius=3.8*roadWidth,finalTerrainMaxHeightNearRoad=-.5,embankmentMaterial=new THREE.MeshStandardMaterial({color:12759680,side:THREE.DoubleSide,flatShading:!1}),embankmentSideExtendDistance=8;let lastSegmentNeededEmbankment=!1;const terrainColor=6986346,skyColor=10535152,fogNear=60,fogFar=150,terrainSkirtDrop=30,treesPerSegment=80;let treeGeometryTrunk,treeGeometryCanopy,treeMaterialTrunk,treeMaterialCanopy;const treeScaleMin=.8,treeScaleMax=1.5,clusterProbability=.35,numTreesInCluster=15,clusterRadius=18,flatnessThreshold=.6,treeAvoidRoadRadius=2.5*roadWidth,guardrailHeight=1,postRadius=.1,railHeight=.15,railSpacing=.3,guardrailMaterial=new THREE.MeshStandardMaterial({color:11184810,roughness:.6,metalness:.4}),guardrailThreshold=2.5;function base64ToArrayBuffer(e){try{const t=atob(e),n=new Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return new Uint8Array(n).buffer}catch(e){throw e}}function createAndStartSource(e,t,n=!0){if(!audioContext||!e||!t)return null;if("running"!==audioContext.state)return null;const a=audioContext.createBufferSource();a.buffer=e,a.loop=n;try{return a.connect(t),a.start(0),a}catch(e){try{a.disconnect()}catch(e){}return null}}function pauseAnimation(){if(!isPaused&&(isPaused=!0,audioContext&&"running"===audioContext.state)){const e=audioContext.currentTime,t=.1;engineGainNode&&engineGainNode.gain.setTargetAtTime(0,e,t/3),musicGainNode&&musicGainNode.gain.setTargetAtTime(0,e,t/3),ambientGainNode&&ambientGainNode.gain.setTargetAtTime(0,e,t/3)}}function resumeAnimation(){if(isPaused){const e=()=>{if(isPaused){if(clock&&clock.getDelta(),audioContext&&"running"===audioContext.state){const e=audioContext.currentTime,t=.1;engineGainNode&&engineGainNode.gain.setTargetAtTime(currentEngineVolume,e,t/3),musicGainNode&&musicGainNode.gain.setTargetAtTime(musicVolume,e,t/3),ambientGainNode&&ambientGainNode.gain.setTargetAtTime(ambientVolume,e,t/3),engineSourceNode&&engineSourceNode.playbackRate.setTargetAtTime(currentEnginePitch,e,.01)}isPaused=!1}};audioContext&&"suspended"===audioContext.state?audioContext.resume().then((()=>{setTimeout(e,50)})).catch((e=>{isPaused=!1})):audioContext&&"running"===audioContext.state?e():isPaused=!1}}function smoothstep(e,t,n){const a=Math.max(0,Math.min(1,(n-e)/(t-e)));return a*a*(3-2*a)}function getEstimatedTerrainHeight(e,t){return simplex.noise2D(5,-t*baseTerrainHeightFreq)*baseTerrainHeightAmp+simplex.noise2D(e*terrainFrequency*.5,-t*terrainFrequency)*terrainAmplitude}function getPathPoint(e){const t=simplex.noise2D(0,-e*curveFrequency)*curveAmplitude,n=simplex.noise2D(5,-e*baseTerrainHeightFreq)*baseTerrainHeightAmp+simplex.noise2D(10,-e*roadHeightVariationFreq)*roadHeightVariationAmp,a=new THREE.Vector3(t,n,-e),i=e+.1,o=simplex.noise2D(0,-i*curveFrequency)*curveAmplitude,r=simplex.noise2D(5,-i*baseTerrainHeightFreq)*baseTerrainHeightAmp+simplex.noise2D(10,-i*roadHeightVariationFreq)*roadHeightVariationAmp;return{position:a,tangent:new THREE.Vector3(o,r,-i).clone().sub(a).normalize()}}function getModifiedTerrainHeight(e,t){const n=getEstimatedTerrainHeight(e,t),a=getPathPoint(-t),i=a.position.x,o=a.position.y,r=Math.abs(e-i),s=o+roadBedOffset;let d;if(r<=roadBlendRadius){const e=1-smoothstep(roadForceRadius,roadBlendRadius,r),t=THREE.MathUtils.lerp(s,o+finalTerrainMaxHeightNearRoad,1-e);d=Math.min(n,t),d=Math.min(d,o+finalTerrainMaxHeightNearRoad)}else d=n;return d}async function init(){clock=new THREE.Clock,scene=new THREE.Scene,scene.fog=new THREE.Fog(10535152,60,150),camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);const e=getPathPoint(2*segmentLength),t=e.position.clone().add(new THREE.Vector3(0,cameraHeight,0)),n=e.position.clone().add(e.tangent.multiplyScalar(cameraLookDistance));camera.position.copy(t),targetCameraPosition.copy(t),targetLookAtPosition.copy(n),camera.lookAt(n),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor(10535152),document.body.appendChild(renderer.domElement);const a=new THREE.AmbientLight(13421772,.8);scene.add(a);const i=new THREE.DirectionalLight(16777215,1);i.position.set(35,50,25),i.castShadow=!1,scene.add(i);const o=new THREE.MeshStandardMaterial({color:4473924,side:THREE.DoubleSide}),r=new THREE.MeshBasicMaterial({color:16777215}),s=new THREE.MeshStandardMaterial({color:6986346,flatShading:!1,side:THREE.DoubleSide});treeGeometryTrunk=new THREE.CylinderGeometry(.15,.2,1.5,5),treeGeometryCanopy=new THREE.ConeGeometry(.8,2.5,6),treeMaterialTrunk=new THREE.MeshLambertMaterial({color:9127187}),treeMaterialCanopy=new THREE.MeshLambertMaterial({color:2263842});for(let e=0;e<numSegments+10;e++)addTerrainSegment(e*segmentLength,s);for(let e=0;e<numSegments;e++)addRoadSegment(e*segmentLength,o,r);try{if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)throw new Error("瀏覽器不支持 Web Audio API");audioContext=new AudioContext;const e=[];engineBase64&&e.push(loadEngineSound()),musicBase64&&e.push(loadMusicSound()),ambientBase64&&e.push(loadAmbientSound()),e.length>0&&await Promise.all(e)}catch(e){displayError("無法初始化音頻功能。請檢查瀏覽器兼容性或控制台錯誤。")}setupVisibilityListeners(),setupAudioInteraction(),window.addEventListener("resize",onWindowResize,!1),animate()}async function loadEngineSound(){if(audioContext&&engineBase64)try{const e=base64ToArrayBuffer(engineBase64);engineSoundBuffer=await audioContext.decodeAudioData(e),setupEngineAudioNodes(),isEngineReady=!0}catch(e){engineSoundBuffer=null,isEngineReady=!1}}async function loadMusicSound(){if(audioContext&&musicBase64)try{const e=base64ToArrayBuffer(musicBase64);musicSoundBuffer=await audioContext.decodeAudioData(e),setupMusicAudioNodes(),isMusicReady=!0}catch(e){musicSoundBuffer=null,isMusicReady=!1}}async function loadAmbientSound(){if(audioContext&&ambientBase64)try{const e=base64ToArrayBuffer(ambientBase64);ambientSoundBuffer=await audioContext.decodeAudioData(e),setupAmbientAudioNodes(),isAmbientReady=!0}catch(e){ambientSoundBuffer=null,isAmbientReady=!1}}function setupEngineAudioNodes(){audioContext&&engineSoundBuffer&&!engineGainNode&&(engineGainNode=audioContext.createGain(),engineGainNode.gain.setValueAtTime(0,audioContext.currentTime),engineGainNode.connect(audioContext.destination))}function setupMusicAudioNodes(){audioContext&&musicSoundBuffer&&!musicGainNode&&(musicGainNode=audioContext.createGain(),musicGainNode.gain.setValueAtTime(0,audioContext.currentTime),musicGainNode.connect(audioContext.destination))}function setupAmbientAudioNodes(){audioContext&&ambientSoundBuffer&&!ambientGainNode&&(ambientGainNode=audioContext.createGain(),ambientGainNode.gain.setValueAtTime(0,audioContext.currentTime),ambientGainNode.connect(audioContext.destination))}function setupAudioInteraction(){const e=async()=>{if(hasAudioStarted||!audioContext)return;if("suspended"===audioContext.state)try{await audioContext.resume()}catch(e){return void displayError("無法自動啟動音頻。請嘗試刷新頁面或檢查瀏覽器設置。")}if("running"!==audioContext.state)return void displayError(`無法啟動音頻 (狀態: ${audioContext.state})`);const t=audioContext.currentTime;isEngineReady&&engineSoundBuffer&&engineGainNode&&!engineSourceNode&&(engineGainNode.gain.setValueAtTime(currentEngineVolume,t),engineSourceNode=createAndStartSource(engineSoundBuffer,engineGainNode,!0),engineSourceNode&&engineSourceNode.playbackRate.setValueAtTime(currentEnginePitch,t)),isMusicReady&&musicSoundBuffer&&musicGainNode&&!musicSourceNode&&(musicGainNode.gain.setValueAtTime(musicVolume,t),musicSourceNode=createAndStartSource(musicSoundBuffer,musicGainNode,!0)),isAmbientReady&&ambientSoundBuffer&&ambientGainNode&&!ambientSourceNode&&(ambientGainNode.gain.setValueAtTime(ambientVolume,t),ambientSourceNode=createAndStartSource(ambientSoundBuffer,ambientGainNode,!0)),hasAudioStarted=!0;const n=document.getElementById("audio-prompt");n&&n.remove(),document.body.removeEventListener("click",e),document.body.removeEventListener("keydown",e)};let t=document.getElementById("audio-prompt");t||isEngineReady&&isMusicReady&&isAmbientReady?!t&&(isEngineReady||isMusicReady||isAmbientReady)?(t=document.createElement("div"),t.id="audio-prompt",t.textContent="點擊或按任意鍵以啟動聲音",document.body.appendChild(t),document.body.addEventListener("click",e,{once:!0}),document.body.addEventListener("keydown",e,{once:!0})):t&&hasAudioStarted&&prompt.remove():setTimeout((()=>setupAudioInteraction()),500)}function displayError(e){let t=document.getElementById("error-message");t||(t=document.createElement("div"),t.id="error-message",t.style.position="absolute",t.style.bottom="10px",t.style.left="10px",t.style.padding="10px",t.style.backgroundColor="rgba(255, 0, 0, 0.8)",t.style.color="white",t.style.zIndex="101",t.style.borderRadius="5px",document.body.appendChild(t)),t.textContent=e}function addRoadSegment(e,t,n){const a=[],i=[],o=[],r=new THREE.Vector3(0,1,0);for(let t=0;t<=15;t++){const n=getPathPoint(e+t/15*segmentLength);a.push(n.position),i.push(n.tangent)}for(let e=0;e<=15;e++){const t=i[e];let n=(new THREE.Vector3).crossVectors(t,r).normalize();Math.abs(t.y)>.98&&(n.crossVectors(t,new THREE.Vector3(1,0,0)).normalize(),n.lengthSq()<.1&&n.crossVectors(t,new THREE.Vector3(0,0,1)).normalize()),o.push(n)}const s=[],d=[],l=[],c=[],u=[],m=roadWidth/2;let g=0,p=-1/0,h=!1,y=!1,E=null,f=null,S=null,x=null;const T=lastSegmentNeededEmbankment;for(let t=0;t<15;t++){const n=a[t],i=a[t+1],T=o[t],b=o[t+1],R=n.clone().add(T.clone().multiplyScalar(-m)),H=n.clone().add(T.clone().multiplyScalar(m)),w=i.clone().add(b.clone().multiplyScalar(m)),A=i.clone().add(b.clone().multiplyScalar(-m));s.push(R.x,R.y,R.z,H.x,H.y,H.z,A.x,A.y,A.z),s.push(H.x,H.y,H.z,w.x,w.y,w.z,A.x,A.y,A.z);const M=n.distanceTo(i);let z=0;const C=2,N=2;let B=0,G=!0,P=e+g;for(G=Math.floor(P/(C+N))%2==0,B=P%(C+N),G||(B-=C);z<M;){const e=M-z,t=G?C:N,a=Math.min(e,t-B);if(G){const e=z/M,t=(z+a)/M,o=n.clone().lerp(i,e),r=n.clone().lerp(i,t);d.push(o.x,o.y+.05,o.z),d.push(r.x,r.y+.05,r.z)}B+=a,z+=a,B>=t&&(G=!G,B=0)}const D=n.clone().lerp(i,.5),k=e+g+.5*M,V=getEstimatedTerrainHeight(D.x,D.z),L=D.y,v=L-V;let F=!1;v>pillarCheckThreshold&&(F=!0,k-p>=pillarSpacing&&(addPillar(D,L,V,e),p=k));const I=!F&&V>L+roadBedOffset+.1;if(I){h=!0;const e=T.clone().multiplyScalar(-embankmentSideExtendDistance),t=T.clone().multiplyScalar(embankmentSideExtendDistance),n=b.clone().multiplyScalar(embankmentSideExtendDistance),a=b.clone().multiplyScalar(-embankmentSideExtendDistance),i=R.x+e.x,o=R.z+e.z,r=H.x+t.x,s=H.z+t.z,d=w.x+n.x,c=w.z+n.z,u=A.x+a.x,m=A.z+a.z,g=getModifiedTerrainHeight(i,o),p=getModifiedTerrainHeight(r,s),y=getModifiedTerrainHeight(d,c),M=getModifiedTerrainHeight(u,m),z=Math.min(g,R.y)-1,C=Math.min(p,H.y)-1,N=Math.min(y,w.y)-1,B=Math.min(M,A.y)-1,G=new THREE.Vector3(i,z,o),P=new THREE.Vector3(r,C,s),D=new THREE.Vector3(d,N,c),k=new THREE.Vector3(u,B,m);l.push(R.x,R.y,R.z,A.x,A.y,A.z,G.x,G.y,G.z),l.push(A.x,A.y,A.z,k.x,k.y,k.z,G.x,G.y,G.z),l.push(H.x,H.y,H.z,w.x,w.y,w.z,P.x,P.y,P.z),l.push(w.x,w.y,w.z,D.x,D.y,D.z,P.x,P.y,P.z),l.push(G.x,G.y,G.z,k.x,k.y,k.z,P.x,P.y,P.z),l.push(k.x,k.y,k.z,D.x,D.y,D.z,P.x,P.y,P.z),null===E&&(E=R.clone(),f=H.clone(),S=G.clone(),x=P.clone())}if(v>guardrailThreshold&&!I){y=!0;const e=.1,t=R.clone().add(T.clone().multiplyScalar(e)),n=A.clone().add(b.clone().multiplyScalar(e)),a=t.clone().add(r.clone().multiplyScalar(guardrailHeight)),i=n.clone().add(r.clone().multiplyScalar(guardrailHeight));c.push(t.x-postRadius,t.y,t.z,t.x+postRadius,t.y,t.z,a.x-postRadius,a.y,a.z),c.push(t.x+postRadius,t.y,t.z,a.x+postRadius,a.y,a.z,a.x-postRadius,a.y,a.z);const o=a.clone().sub(r.clone().multiplyScalar(railHeight)),s=i.clone().sub(r.clone().multiplyScalar(railHeight));c.push(o.x,o.y,o.z,s.x,s.y,s.z,a.x,a.y,a.z),c.push(s.x,s.y,s.z,i.x,i.y,i.z,a.x,a.y,a.z);const d=o.clone().sub(r.clone().multiplyScalar(railSpacing)),l=s.clone().sub(r.clone().multiplyScalar(railSpacing)),m=d.clone().sub(r.clone().multiplyScalar(railHeight)),g=l.clone().sub(r.clone().multiplyScalar(railHeight));c.push(m.x,m.y,m.z,g.x,g.y,g.z,d.x,d.y,d.z),c.push(g.x,g.y,g.z,l.x,l.y,l.z,d.x,d.y,d.z);const p=H.clone().add(T.clone().multiplyScalar(-e)),h=w.clone().add(b.clone().multiplyScalar(-e)),E=p.clone().add(r.clone().multiplyScalar(guardrailHeight)),f=h.clone().add(r.clone().multiplyScalar(guardrailHeight));u.push(p.x-postRadius,p.y,p.z,p.x+postRadius,p.y,p.z,E.x-postRadius,E.y,E.z),u.push(p.x+postRadius,p.y,p.z,E.x+postRadius,E.y,E.z,E.x-postRadius,E.y,E.z);const S=E.clone().sub(r.clone().multiplyScalar(railHeight)),x=f.clone().sub(r.clone().multiplyScalar(railHeight));u.push(S.x,S.y,S.z,E.x,E.y,E.z,x.x,x.y,x.z),u.push(x.x,x.y,x.z,E.x,E.y,E.z,f.x,f.y,f.z);const M=S.clone().sub(r.clone().multiplyScalar(railSpacing)),z=x.clone().sub(r.clone().multiplyScalar(railSpacing)),C=M.clone().sub(r.clone().multiplyScalar(railHeight)),N=z.clone().sub(r.clone().multiplyScalar(railHeight));u.push(C.x,C.y,C.z,M.x,M.y,M.z,N.x,N.y,N.z),u.push(N.x,N.y,N.z,M.x,M.y,M.z,z.x,z.y,z.z)}g+=M}const b=a[0],R=getEstimatedTerrainHeight(b.x,b.z);b.y-R>pillarCheckThreshold&&addPillar(b,b.y,R,e);const H=a[15],w=getEstimatedTerrainHeight(H.x,H.z);H.y-w>pillarCheckThreshold&&e+segmentLength-p>=pillarSpacing/2&&addPillar(H,H.y,w,e);const A=new THREE.BufferGeometry;A.setAttribute("position",new THREE.Float32BufferAttribute(s,3)),A.computeVertexNormals();const M=new THREE.Mesh(A,t);if(M.userData={type:"road",distance:e},scene.add(M),roadSegments.push(M),d.length>0){const t=new THREE.BufferGeometry;t.setAttribute("position",new THREE.Float32BufferAttribute(d,3));const a=new THREE.LineSegments(t,n);a.userData={type:"line",distance:e},scene.add(a),roadSegments.push(a)}if(h&&l.length>0){T||null===E||(l.push(E.x,E.y,E.z,S.x,S.y,S.z,x.x,x.y,x.z),l.push(E.x,E.y,E.z,x.x,x.y,x.z,f.x,f.y,f.z));const t=new THREE.BufferGeometry;t.setAttribute("position",new THREE.Float32BufferAttribute(l,3)),t.computeVertexNormals();const n=new THREE.Mesh(t,embankmentMaterial);n.userData={type:"embankment",distance:e},scene.add(n),embankmentSegments.push(n)}if(y){if(c.length>0){const t=new THREE.BufferGeometry;t.setAttribute("position",new THREE.Float32BufferAttribute(c,3)),t.computeVertexNormals();const n=new THREE.Mesh(t,guardrailMaterial);n.userData={type:"guardrail",distance:e},scene.add(n),guardrailSegments.push(n)}if(u.length>0){const t=new THREE.BufferGeometry;t.setAttribute("position",new THREE.Float32BufferAttribute(u,3)),t.computeVertexNormals();const n=new THREE.Mesh(t,guardrailMaterial);n.userData={type:"guardrail",distance:e},scene.add(n),guardrailSegments.push(n)}}lastSegmentNeededEmbankment=h}function addPillar(e,t,n,a){if(t-n<=.1)return;const i=n,o=t-.1-i;if(o<=.1)return;const r=new THREE.CylinderGeometry(pillarRadius,pillarRadius,o,8),s=new THREE.Mesh(r,pillarMaterial);s.position.set(e.x,i+o/2,e.z),s.userData={type:"pillar",distance:a},scene.add(s),pillars.push(s)}function addTerrainSegment(e,t){const n=terrainDetail,a=Math.max(1,Math.floor(segmentLength/5)),i=new THREE.PlaneGeometry(terrainWidth,segmentLength,n,a),o=i.attributes.position,r=o.count,s=new Float32Array(3*r),d=getPathPoint(e+segmentLength/2),l=.01,c=[],u=new THREE.Object3D;for(let e=0;e<r;e++){const t=o.getX(e),n=o.getY(e),a=d.position.z-n,i=d.position.x+t,r=getModifiedTerrainHeight(i,a);s[3*e]=i,s[3*e+1]=r,s[3*e+2]=a}if(Math.random()<clusterProbability){const e=Math.random()*terrainWidth-terrainWidth/2,t=Math.random()*segmentLength-segmentLength/2,n=d.position.x+e,a=d.position.z-t,i=getPathPoint(-a).position.x;if(Math.abs(n-i)>treeAvoidRoadRadius){const e=getEstimatedTerrainHeight(n,a),t=getEstimatedTerrainHeight(n+1,a),i=getEstimatedTerrainHeight(n,a+1);if(Math.abs(e-t)<flatnessThreshold&&Math.abs(e-i)<flatnessThreshold){const e=Math.round(numTreesInCluster*(.75+.5*Math.random()));for(let t=0;t<e;t++){const e=Math.random()*Math.PI*2,t=Math.random()*clusterRadius,i=n+Math.cos(e)*t,o=a+Math.sin(e)*t,r=getModifiedTerrainHeight(i,o);u.position.set(i,r,o),u.rotation.y=Math.random()*Math.PI*2;const s=THREE.MathUtils.randFloat(treeScaleMin,treeScaleMax);u.scale.set(s,s,s),u.updateMatrix(),c.push(u.matrix.clone())}}}}for(let e=0;e<r;e++){const t=o.getX(e),n=o.getY(e);(Math.abs(t- -terrainWidth/2)<l||Math.abs(t-terrainWidth/2)<l||Math.abs(n- -segmentLength/2)<l||Math.abs(n-segmentLength/2)<l)&&(s[3*e+1]-=terrainSkirtDrop)}const m=new THREE.BufferGeometry;m.setAttribute("position",new THREE.Float32BufferAttribute(s,3)),m.setIndex(i.index),m.computeVertexNormals();const g=new THREE.Mesh(m,t);if(g.userData={type:"terrain",distance:e},scene.add(g),terrainSegments.push(g),c.length>0){const t=c.length,n=new THREE.InstancedMesh(treeGeometryTrunk,treeMaterialTrunk,t),a=new THREE.InstancedMesh(treeGeometryCanopy,treeMaterialCanopy,t),i=1.3;for(let e=0;e<t;e++){const t=c[e],o=t.clone(),r=new THREE.Vector3,s=new THREE.Quaternion,d=new THREE.Vector3;t.decompose(r,s,d),r.y+=i*d.y,o.compose(r,s,d),n.setMatrixAt(e,t),a.setMatrixAt(e,o)}n.instanceMatrix.needsUpdate=!0,a.instanceMatrix.needsUpdate=!0,n.userData={type:"trees",distance:e},a.userData={type:"trees",distance:e},scene.add(n),scene.add(a),treeInstances.push(n),treeInstances.push(a)}i.dispose()}function setupVisibilityListeners(){if(document.addEventListener("visibilitychange",(()=>{document.hidden?pauseAnimation():resumeAnimation()})),window.wallpaperPropertyListener&&(window.wallpaperPropertyListener.applyUserProperties=function(e){let t=!1;e.visibility&&"boolean"==typeof e.visibility.value?!1===e.visibility.value&&(t=!0):e.visibility,e.pause&&"boolean"==typeof e.pause.value?!0===e.pause.value&&(t=!0):e.pause,t?isPaused||pauseAnimation():isPaused&&resumeAnimation()},window.wallpaperRequestUserProperties))try{window.wallpaperRequestUserProperties()}catch(e){}}function animate(){if(animationFrameId=requestAnimationFrame(animate),isPaused)return;let e=clock.getDelta();if(e>.5&&(e=.5),e>0){currentPathDistance+=driveSpeed*e;const t=getPathPoint(currentPathDistance),n=t.position,a=t.tangent,i=new THREE.Vector3(0,1,0),o=(new THREE.Vector3).crossVectors(a,i).normalize(),r=n.clone().add(i.multiplyScalar(cameraHeight)).add(o.multiplyScalar(rightLaneOffset)),s=n.clone().add(a.multiplyScalar(cameraLookDistance));if(camera.position.lerp(r,cameraFollowSpeed),targetLookAtPosition.lerp(s,cameraFollowSpeed),camera.lookAt(targetLookAtPosition),isEngineReady&&engineSourceNode&&engineGainNode&&"running"===audioContext?.state){const t=audioContext.currentTime,n=.05,a=.05,i=.6+driveSpeed/25*1.4,o=getPathPoint(currentPathDistance).tangent.y;let r=i,s=baseEngineVolume;const d=.02,l=.4,c=.3;o>d?(r+=o*l,s+=o*c):o<-d&&(r+=o*l*.8,s+=o*c*.5),r=Math.max(.4,Math.min(r,2.5)),s=Math.max(.3,Math.min(s,1)),currentEnginePitch=THREE.MathUtils.lerp(currentEnginePitch,r,e*pitchChangeSpeed),currentEngineVolume=THREE.MathUtils.lerp(currentEngineVolume,s,e*volumeChangeSpeed);try{engineSourceNode&&engineGainNode&&(engineSourceNode.playbackRate.setTargetAtTime(currentEnginePitch,t,a),engineGainNode.gain.setTargetAtTime(currentEngineVolume,t,n))}catch(e){}}const d=80,l=(numSegments-4)*segmentLength,c=[];for(let e=treeInstances.length-1;e>=0;e--){const t=treeInstances[e];-t.userData.distance-segmentLength>camera.position.z+d&&(c.push(e),scene.remove(t))}c.forEach((e=>treeInstances.splice(e,1)));const u=[];for(let e=guardrailSegments.length-1;e>=0;e--){const t=guardrailSegments[e];-t.userData.distance-segmentLength>camera.position.z+d&&(u.push(e),scene.remove(t),t.geometry&&t.geometry.dispose())}u.forEach((e=>guardrailSegments.splice(e,1)));const m=[];for(let e=embankmentSegments.length-1;e>=0;e--){const t=embankmentSegments[e];-t.userData.distance-segmentLength>camera.position.z+d&&(m.push(e),scene.remove(t),t.geometry&&t.geometry.dispose())}m.forEach((e=>embankmentSegments.splice(e,1)));const g=[];for(let e=roadSegments.length-1;e>=0;e--){const t=roadSegments[e];-t.userData.distance-segmentLength>camera.position.z+d&&(g.push(e),scene.remove(t),t.geometry&&t.geometry.dispose())}g.forEach((e=>roadSegments.splice(e,1)));const p=[];for(let e=terrainSegments.length-1;e>=0;e--){const t=terrainSegments[e];-t.userData.distance-segmentLength>camera.position.z+d&&(p.push(e),scene.remove(t),t.geometry&&t.geometry.dispose())}p.forEach((e=>terrainSegments.splice(e,1)));const h=[];for(let e=pillars.length-1;e>=0;e--){const t=pillars[e];t.position.z>camera.position.z+d+segmentLength&&(h.push(e),scene.remove(t),t.geometry&&t.geometry.dispose())}h.forEach((e=>pillars.splice(e,1)));let y=0;roadSegments.forEach((e=>y=Math.max(y,e.userData.distance)));let E=0;terrainSegments.forEach((e=>E=Math.max(E,e.userData.distance)));const f=currentPathDistance+l;for(;E<f+3*segmentLength;){const e=E+segmentLength,t=terrainSegments.length>0?terrainSegments[0].material:null;if(!t)break;addTerrainSegment(e,t),E=e}for(;y<f;){const e=y+segmentLength,t=roadSegments.length>0?roadSegments.find((e=>"road"===e.userData.type))?.material:null,n=roadSegments.length>0?roadSegments.find((e=>"line"===e.userData.type))?.material:null;if(!t||!n)break;addRoadSegment(e,t,n),y=e}}renderer&&scene&&camera?renderer.render(scene,camera):animationFrameId&&cancelAnimationFrame(animationFrameId)}function onWindowResize(){camera&&renderer&&(camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight))}try{init()}catch(e){displayError("載入時發生嚴重錯誤，請檢查控制台。")}